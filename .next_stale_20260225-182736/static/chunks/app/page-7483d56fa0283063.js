(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{4839:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>P});var r=s(5155),a=s(2115);let l=e=>{let t,s=new Set,r=(e,r)=>{let a="function"==typeof e?e(t):e;if(!Object.is(a,t)){let e=t;t=(null!=r?r:"object"!=typeof a||null===a)?a:Object.assign({},t,a),s.forEach(s=>s(t,e))}},a=()=>t,l={setState:r,getState:a,getInitialState:()=>i,subscribe:e=>(s.add(e),()=>s.delete(e))},i=t=e(r,a,l);return l},i=e=>{let t=(e=>e?l(e):l)(e),s=e=>(function(e,t=e=>e){let s=a.useSyncExternalStore(e.subscribe,a.useCallback(()=>t(e.getState()),[e,t]),a.useCallback(()=>t(e.getInitialState()),[e,t]));return a.useDebugValue(s),s})(t,e);return Object.assign(s,t),s},n=(e=>e?i(e):i)(e=>({selectedDetectionId:null,setSelectedDetectionId:t=>e({selectedDetectionId:t}),activeTab:0,setActiveTab:t=>e({activeTab:t}),apiKey:"",setApiKey:t=>e({apiKey:t}),selectedModel:"gemini-2.5-flash",setSelectedModel:t=>e({selectedModel:t}),selectedRunByDetection:{},setSelectedRunForDetection:(t,s)=>e(e=>({selectedRunByDetection:{...e.selectedRunByDetection,[t]:s}})),clearSelectedRunForDetection:t=>e(e=>{let s={...e.selectedRunByDetection};return delete s[t],{selectedRunByDetection:s}}),refreshCounter:0,triggerRefresh:()=>e(e=>({refreshCounter:e.refreshCounter+1}))})),d=["gemini-3.1-flash","gemini-3.1-pro","gemini-3-flash","gemini-3-pro","gemini-2.5-flash","gemini-2.5-pro","gemini-2.0-flash"];function c(e){let{metrics:t,label:s,compact:a}=e,l=e=>(100*e).toFixed(1)+"%";return a?(0,r.jsxs)("div",{className:"flex gap-3 text-xs",children:[(0,r.jsxs)("span",{children:["P: ",(0,r.jsx)("b",{className:"text-blue-400",children:l(t.precision)})]}),(0,r.jsxs)("span",{children:["R: ",(0,r.jsx)("b",{className:"text-green-400",children:l(t.recall)})]}),(0,r.jsxs)("span",{children:["F1: ",(0,r.jsx)("b",{className:"text-yellow-400",children:l(t.f1)})]}),(0,r.jsxs)("span",{children:["Acc: ",(0,r.jsx)("b",{className:"text-gray-300",children:l(t.accuracy)})]})]}):(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-4",children:[s&&(0,r.jsx)("h3",{className:"text-sm font-medium text-gray-300 mb-3",children:s}),(0,r.jsxs)("div",{className:"grid grid-cols-5 gap-3 mb-4",children:[(0,r.jsx)(o,{label:"Precision",value:l(t.precision),color:"text-blue-400"}),(0,r.jsx)(o,{label:"Recall",value:l(t.recall),color:"text-green-400"}),(0,r.jsx)(o,{label:"F1 Score",value:l(t.f1),color:"text-yellow-400"}),(0,r.jsx)(o,{label:"Accuracy",value:l(t.accuracy),color:"text-gray-200"}),(0,r.jsx)(o,{label:"Prevalence",value:l(t.prevalence),color:"text-purple-400"})]}),(0,r.jsxs)("div",{className:"flex gap-6 items-start",children:[(0,r.jsxs)("div",{className:"shrink-0",children:[(0,r.jsx)("p",{className:"text-xs text-gray-500 mb-2 font-medium",children:"Confusion Matrix"}),(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-0 text-xs",children:[(0,r.jsx)("div",{}),(0,r.jsx)("div",{className:"text-center text-gray-500 pb-1 px-2",children:"Pred +"}),(0,r.jsx)("div",{className:"text-center text-gray-500 pb-1 px-2",children:"Pred −"}),(0,r.jsx)("div",{className:"text-gray-500 pr-2 text-right",children:"Act +"}),(0,r.jsx)("div",{className:"bg-green-900/30 border border-green-800/50 px-3 py-2 text-center font-mono text-green-400",children:t.tp}),(0,r.jsx)("div",{className:"bg-red-900/30 border border-red-800/50 px-3 py-2 text-center font-mono text-red-400",children:t.fn}),(0,r.jsx)("div",{className:"text-gray-500 pr-2 text-right",children:"Act −"}),(0,r.jsx)("div",{className:"bg-red-900/30 border border-red-800/50 px-3 py-2 text-center font-mono text-red-400",children:t.fp}),(0,r.jsx)("div",{className:"bg-green-900/30 border border-green-800/50 px-3 py-2 text-center font-mono text-green-400",children:t.tn})]})]}),(0,r.jsxs)("div",{className:"text-xs space-y-1 text-gray-400",children:[(0,r.jsxs)("p",{children:["Total: ",(0,r.jsx)("span",{className:"text-white",children:t.total})]}),(0,r.jsxs)("p",{children:["TP: ",(0,r.jsx)("span",{className:"text-green-400",children:t.tp})," | FP: ",(0,r.jsx)("span",{className:"text-red-400",children:t.fp})]}),(0,r.jsxs)("p",{children:["FN: ",(0,r.jsx)("span",{className:"text-red-400",children:t.fn})," | TN: ",(0,r.jsx)("span",{className:"text-green-400",children:t.tn})]}),(0,r.jsxs)("p",{children:["Parse failures: ",(0,r.jsx)("span",{className:t.parse_failure_rate>0?"text-yellow-400":"text-gray-400",children:l(t.parse_failure_rate)})]})]})]})]})}function o(e){let{label:t,value:s,color:a}=e;return(0,r.jsxs)("div",{className:"bg-gray-900/50 rounded px-3 py-2 text-center",children:[(0,r.jsx)("div",{className:"text-lg font-semibold ".concat(a),children:s}),(0,r.jsx)("div",{className:"text-xs text-gray-500",children:t})]})}function x(e){let{detections:t,selectedDetection:s,onRefresh:l}=e,{apiKey:i,selectedModel:d,setSelectedDetectionId:o,setActiveTab:x,setSelectedRunForDetection:h}=n(),[u,g]=(0,a.useState)("view"),[b,y]=(0,a.useState)([]),[j,_]=(0,a.useState)([]),[N,v]=(0,a.useState)([]),[f,E]=(0,a.useState)(""),[w,T]=(0,a.useState)(""),[D,C]=(0,a.useState)(null),[S,k]=(0,a.useState)([]),[O,P]=(0,a.useState)("all"),[A,I]=(0,a.useState)(!1),[L,R]=(0,a.useState)(null),[F,U]=(0,a.useState)(!1),[M,V]=(0,a.useState)(!1),[H,G]=(0,a.useState)({detection_code:"",display_name:"",description:"",label_policy:"",decision_rubric:[""],metric_thresholds:{primary_metric:"f1",min_precision:.8,min_recall:.8,min_f1:.8}}),J=(0,a.useCallback)(async()=>{if(!s)return;let[e,t,r]=await Promise.all([fetch("/api/prompts?detection_id=".concat(s.detection_id)),fetch("/api/datasets?detection_id=".concat(s.detection_id)),fetch("/api/runs?detection_id=".concat(s.detection_id))]);y(await e.json()),_(await t.json()),v(await r.json())},[s]);(0,a.useEffect)(()=>{J()},[J]),(0,a.useEffect)(()=>{!f&&b.length>0&&E(b[0].prompt_version_id)},[b,f]),(0,a.useEffect)(()=>{0===j.length||w&&j.some(e=>e.dataset_id===w)||T((j.find(e=>"ITERATION"===e.split_type)||j.find(e=>"CUSTOM"===e.split_type)||j[0]).dataset_id)},[j,w]),(0,a.useEffect)(()=>{C(null),k([]),R(null),P("all")},[null==s?void 0:s.detection_id]);let z=async()=>{if(s){if(!i)return void alert("Set your Gemini API key first.");if(!f||!w)return void alert("Choose a prompt and dataset before running.");I(!0),C(null),k([]),R(null);try{let e=await fetch("/api/runs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:i,model_override:d,prompt_version_id:f,dataset_id:w,detection_id:s.detection_id})}),t=await e.json();if(!(null==t?void 0:t.run_id))return void alert((null==t?void 0:t.error)||"Run failed");let r=await fetch("/api/runs?run_id=".concat(t.run_id)),a=await r.json();C(a),k(a.predictions||[]),h(s.detection_id,a.run_id),J()}catch(e){console.error(e),alert("Run failed")}finally{I(!1)}}},B=S.filter(e=>{switch(O){case"fp":return e.parse_ok&&"DETECTED"===e.predicted_decision&&"NOT_DETECTED"===e.ground_truth_label;case"fn":return e.parse_ok&&"NOT_DETECTED"===e.predicted_decision&&"DETECTED"===e.ground_truth_label;case"parse_fail":return!e.parse_ok;case"correct":return e.parse_ok&&e.predicted_decision===e.ground_truth_label;default:return!0}}),K=async()=>{let e=await fetch("/api/detections",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...H,decision_rubric:H.decision_rubric.filter(e=>e.trim())})});o((await e.json()).detection_id),g("view"),l()},Y=async()=>{s&&(await fetch("/api/detections",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({detection_id:s.detection_id,display_name:H.display_name,description:H.description,label_policy:H.label_policy,decision_rubric:H.decision_rubric.filter(e=>e.trim()),metric_thresholds:H.metric_thresholds,approved_prompt_version:s.approved_prompt_version})}),g("view"),l())},W=()=>{G({detection_code:"",display_name:"",description:"",label_policy:"",decision_rubric:[""],metric_thresholds:{primary_metric:"f1",min_precision:.8,min_recall:.8,min_f1:.8}}),g("create")};return(0,r.jsxs)("div",{className:"max-w-6xl mx-auto space-y-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"Detection Setup"}),(0,r.jsxs)("div",{className:"flex gap-2",children:["view"===u&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:W,className:"px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded text-sm",children:"New Detection"}),s&&(0,r.jsx)("button",{onClick:()=>{s&&(G({detection_code:s.detection_code,display_name:s.display_name,description:s.description,label_policy:s.label_policy,decision_rubric:s.decision_rubric.length>0?s.decision_rubric:[""],metric_thresholds:s.metric_thresholds}),g("edit"))},className:"px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm",children:"Edit"})]}),"view"!==u&&(0,r.jsx)("button",{onClick:()=>g("view"),className:"px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm",children:"Cancel"})]})]}),"view"!==u&&(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-6 space-y-4",children:[(0,r.jsx)("h3",{className:"text-sm font-medium text-gray-300",children:"create"===u?"Create Detection":"Edit Detection"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Detection Code"}),(0,r.jsx)("input",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm disabled:opacity-50",value:H.detection_code,onChange:e=>G({...H,detection_code:e.target.value.toUpperCase().replace(/[^A-Z0-9_]/g,"")}),disabled:"edit"===u,placeholder:"e.g. SMOKE_VISIBLE"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Display Name"}),(0,r.jsx)("input",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm",value:H.display_name,onChange:e=>G({...H,display_name:e.target.value}),placeholder:"e.g. Visible Smoke Detection"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Description"}),(0,r.jsx)("textarea",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm h-20",value:H.description,onChange:e=>G({...H,description:e.target.value})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Label Policy (DETECTED / NOT_DETECTED / Edge Cases)"}),(0,r.jsx)("textarea",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm h-24",value:H.label_policy,onChange:e=>G({...H,label_policy:e.target.value})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Decision Rubric (3-7 criteria)"}),H.decision_rubric.map((e,t)=>(0,r.jsxs)("div",{className:"flex gap-2 mb-2",children:[(0,r.jsxs)("span",{className:"text-xs text-gray-500 mt-2",children:[t+1,"."]}),(0,r.jsx)("input",{className:"flex-1 bg-gray-900 border border-gray-600 rounded px-3 py-1.5 text-sm",value:e,onChange:e=>{let s=[...H.decision_rubric];s[t]=e.target.value,G({...H,decision_rubric:s})}}),H.decision_rubric.length>1&&(0,r.jsx)("button",{onClick:()=>G({...H,decision_rubric:H.decision_rubric.filter((e,s)=>s!==t)}),className:"text-gray-500 hover:text-red-400 text-xs",children:"Remove"})]},t)),H.decision_rubric.length<7&&(0,r.jsx)("button",{onClick:()=>G({...H,decision_rubric:[...H.decision_rubric,""]}),className:"text-xs text-blue-400 hover:text-blue-300",children:"+ Add criterion"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-2",children:"Metric Thresholds"}),(0,r.jsxs)("div",{className:"grid grid-cols-4 gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-500",children:"Primary Metric"}),(0,r.jsxs)("select",{className:"w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-sm mt-1",value:H.metric_thresholds.primary_metric,onChange:e=>G({...H,metric_thresholds:{...H.metric_thresholds,primary_metric:e.target.value}}),children:[(0,r.jsx)("option",{value:"precision",children:"Precision"}),(0,r.jsx)("option",{value:"recall",children:"Recall"}),(0,r.jsx)("option",{value:"f1",children:"F1"})]})]}),["min_precision","min_recall","min_f1"].map(e=>{var t;return(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-500",children:e.replace("min_","Min ")}),(0,r.jsx)("input",{type:"number",step:"0.01",min:"0",max:"1",className:"w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-sm mt-1",value:null!=(t=H.metric_thresholds[e])?t:"",onChange:t=>G({...H,metric_thresholds:{...H.metric_thresholds,[e]:parseFloat(t.target.value)||void 0}})})]},e)})]})]}),(0,r.jsx)("button",{onClick:"create"===u?K:Y,className:"px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm font-medium",children:"create"===u?"Create Detection":"Save Changes"})]}),"view"===u&&s&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between mb-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-lg font-semibold",children:s.display_name}),(0,r.jsx)("code",{className:"text-xs text-gray-400 bg-gray-900 px-2 py-0.5 rounded mt-1 inline-block",children:s.detection_code})]}),s.approved_prompt_version&&(0,r.jsx)("span",{className:"text-xs bg-green-900/30 text-green-400 border border-green-800/50 px-2 py-1 rounded",children:"Approved prompt set"})]}),(0,r.jsx)("p",{className:"text-sm text-gray-400 mb-3",children:s.description}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"text-xs text-gray-500 font-medium mb-1",children:"Label Policy"}),(0,r.jsx)("p",{className:"text-gray-300 whitespace-pre-wrap text-xs",children:s.label_policy})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"text-xs text-gray-500 font-medium mb-1",children:"Decision Rubric"}),(0,r.jsx)("ol",{className:"list-decimal list-inside text-xs text-gray-300 space-y-0.5",children:s.decision_rubric.map((e,t)=>(0,r.jsx)("li",{children:e},t))})]})]}),(0,r.jsxs)("div",{className:"mt-3 flex gap-4 text-xs text-gray-400",children:[(0,r.jsxs)("span",{children:["Primary: ",(0,r.jsx)("b",{className:"text-gray-300",children:s.metric_thresholds.primary_metric})]}),null!=s.metric_thresholds.min_precision&&(0,r.jsxs)("span",{children:["Min Prec: ",(0,r.jsx)("b",{children:s.metric_thresholds.min_precision})]}),null!=s.metric_thresholds.min_recall&&(0,r.jsxs)("span",{children:["Min Recall: ",(0,r.jsx)("b",{children:s.metric_thresholds.min_recall})]}),null!=s.metric_thresholds.min_f1&&(0,r.jsxs)("span",{children:["Min F1: ",(0,r.jsx)("b",{children:s.metric_thresholds.min_f1})]})]})]}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsxs)("h3",{className:"text-sm font-medium",children:["Prompt Versions (",b.length,")"]}),(0,r.jsx)("button",{onClick:()=>U(!F),className:"text-xs px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded",children:F?"Cancel":"New Prompt Version"})]}),F&&(0,r.jsx)(p,{detectionId:s.detection_id,detectionCode:s.detection_code,onSaved:()=>{U(!1),J()}}),(0,r.jsxs)("div",{className:"space-y-2",children:[b.map(e=>(0,r.jsxs)("div",{className:"border rounded-lg p-3 text-sm ".concat(e.prompt_version_id===s.approved_prompt_version?"border-green-700 bg-green-900/10":"border-gray-700 bg-gray-900/30"),children:[(0,r.jsxs)("div",{className:"flex justify-between items-start",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-medium",children:e.version_label}),(0,r.jsxs)("span",{className:"text-xs text-gray-500 ml-2",children:[e.model," | temp=",e.temperature]}),e.prompt_version_id===s.approved_prompt_version&&(0,r.jsx)("span",{className:"ml-2 text-xs text-green-400",children:"APPROVED"})]}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleDateString()})]}),e.change_notes&&(0,r.jsx)("p",{className:"text-xs text-gray-400 mt-1",children:e.change_notes}),e.golden_set_regression_result&&(0,r.jsx)("div",{className:"mt-2 text-xs",children:(0,r.jsxs)("span",{className:e.golden_set_regression_result.passed?"text-green-400":"text-red-400",children:["Regression: ",e.golden_set_regression_result.passed?"PASSED":"FAILED"]})})]},e.prompt_version_id)),0===b.length&&(0,r.jsx)("p",{className:"text-sm text-gray-500 text-center py-4",children:"No prompt versions yet. Create one to get started."})]})]}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5 space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-sm font-medium",children:"Initial Run and Prompt Iteration"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Run on an iteration dataset, inspect outcomes and previews, then iterate quickly."})]}),(0,r.jsx)("button",{onClick:z,disabled:A||!f||!w,className:"text-xs px-3 py-1.5 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 rounded",children:A?"Running...":"Run Now"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Prompt Version"}),(0,r.jsxs)("select",{className:"w-full bg-gray-900 border border-gray-600 rounded px-2.5 py-2 text-sm",value:f,onChange:e=>E(e.target.value),children:[(0,r.jsx)("option",{value:"",children:"Select prompt"}),b.map(e=>(0,r.jsxs)("option",{value:e.prompt_version_id,children:[e.version_label," | ",e.model," | temp=",e.temperature]},e.prompt_version_id))]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Dataset"}),(0,r.jsxs)("select",{className:"w-full bg-gray-900 border border-gray-600 rounded px-2.5 py-2 text-sm",value:w,onChange:e=>T(e.target.value),children:[(0,r.jsx)("option",{value:"",children:"Select dataset"}),j.filter(e=>"HELD_OUT_EVAL"!==e.split_type).map(e=>(0,r.jsxs)("option",{value:e.dataset_id,children:[e.name," (",e.split_type,", ",e.size," images)"]},e.dataset_id))]})]})]}),D&&D.metrics_summary&&(0,r.jsx)(c,{metrics:D.metrics_summary,label:"Run ".concat(D.run_id.slice(0,8)," Results")}),S.length>0&&(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("div",{className:"flex gap-2 flex-wrap",children:[["all","All"],["fp","False Positives"],["fn","False Negatives"],["parse_fail","Parse Failures"],["correct","Correct"]].map(e=>{let[t,s]=e;return(0,r.jsx)("button",{onClick:()=>P(t),className:"text-xs px-2.5 py-1 rounded-full ".concat(O===t?"bg-blue-600 text-white":"bg-gray-900 text-gray-400 border border-gray-700 hover:bg-gray-800"),children:s},t)})}),(0,r.jsx)("div",{className:"overflow-x-auto max-h-[420px] overflow-y-auto border border-gray-700 rounded-lg",children:(0,r.jsxs)("table",{className:"w-full text-xs",children:[(0,r.jsx)("thead",{className:"sticky top-0 bg-gray-800 z-10",children:(0,r.jsxs)("tr",{className:"text-gray-500 border-b border-gray-700",children:[(0,r.jsx)("th",{className:"text-left py-2 px-3",children:"Image"}),(0,r.jsx)("th",{className:"text-left py-2 px-3",children:"Preview"}),(0,r.jsx)("th",{className:"text-center py-2 px-3",children:"Ground Truth"}),(0,r.jsx)("th",{className:"text-center py-2 px-3",children:"Prediction"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"Confidence"}),(0,r.jsx)("th",{className:"text-left py-2 px-3",children:"Evidence"}),(0,r.jsx)("th",{className:"text-center py-2 px-3",children:"Parse"})]})}),(0,r.jsx)("tbody",{children:B.map(e=>(0,r.jsxs)("tr",{className:"border-b border-gray-800/60 hover:bg-gray-800/40",children:[(0,r.jsx)("td",{className:"py-2 px-3 font-mono text-gray-300",children:e.image_id}),(0,r.jsx)("td",{className:"py-2 px-3",children:(0,r.jsx)("img",{src:e.image_uri,alt:e.image_id,className:"w-12 h-9 object-cover rounded cursor-pointer hover:opacity-80",onClick:()=>R(e.image_uri)})}),(0,r.jsx)("td",{className:"text-center py-2 px-3",children:(0,r.jsx)("span",{className:"px-1.5 py-0.5 rounded ".concat("DETECTED"===e.ground_truth_label?"bg-green-900/30 text-green-400":"bg-gray-800 text-gray-400"),children:e.ground_truth_label})}),(0,r.jsx)("td",{className:"text-center py-2 px-3",children:(0,r.jsx)("span",{className:"px-1.5 py-0.5 rounded ".concat("DETECTED"===e.predicted_decision?"bg-green-900/30 text-green-400":"NOT_DETECTED"===e.predicted_decision?"bg-gray-800 text-gray-400":"bg-red-900/30 text-red-400"),children:e.predicted_decision||"PARSE_FAIL"})}),(0,r.jsx)("td",{className:"text-right py-2 px-3 text-gray-300",children:null!=e.confidence?e.confidence.toFixed(2):"—"}),(0,r.jsx)("td",{className:"py-2 px-3 text-gray-400 truncate max-w-[340px]",children:e.evidence||"—"}),(0,r.jsx)("td",{className:"text-center py-2 px-3",children:(0,r.jsx)("span",{className:e.parse_ok?"text-green-400":"text-red-400",children:e.parse_ok?"OK":"FAIL"})})]},e.prediction_id))})]})}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("button",{onClick:()=>x(1),className:"text-xs px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded",children:"Continue to HIL Review"}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:"The latest run is carried into HIL and Prompt Feedback."})]})]})]}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsxs)("h3",{className:"text-sm font-medium",children:["Datasets (",j.length,")"]}),(0,r.jsx)("button",{onClick:()=>V(!M),className:"text-xs px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded",children:M?"Cancel":"Upload Dataset"})]}),M&&(0,r.jsx)(m,{detectionId:s.detection_id,onUploaded:()=>{V(!1),J()}}),(0,r.jsxs)("div",{className:"space-y-2",children:[j.map(e=>(0,r.jsxs)("div",{className:"border border-gray-700 bg-gray-900/30 rounded-lg p-3 flex justify-between items-center",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-sm font-medium",children:e.name}),(0,r.jsx)("span",{className:"ml-2 text-xs px-1.5 py-0.5 rounded ".concat(function(e){switch(e){case"GOLDEN":return"bg-yellow-900/30 text-yellow-400 border border-yellow-800/50";case"ITERATION":return"bg-blue-900/30 text-blue-400 border border-blue-800/50";case"HELD_OUT_EVAL":return"bg-purple-900/30 text-purple-400 border border-purple-800/50";default:return"bg-gray-800 text-gray-400"}}(e.split_type)),children:e.split_type})]}),(0,r.jsxs)("span",{className:"text-xs text-gray-500",children:[e.size," images"]})]},e.dataset_id)),0===j.length&&(0,r.jsx)("p",{className:"text-sm text-gray-500 text-center py-4",children:"No datasets yet. Upload one to begin evaluation."})]})]}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsxs)("h3",{className:"text-sm font-medium mb-4",children:["Recent Runs (",N.length,")"]}),(0,r.jsxs)("div",{className:"space-y-2",children:[N.slice(0,10).map(e=>{var t;return(0,r.jsxs)("div",{className:"border border-gray-700 bg-gray-900/30 rounded-lg p-3 text-sm",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-xs font-mono text-gray-400",children:e.run_id.slice(0,8)}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleString()})]}),(0,r.jsxs)("div",{className:"flex gap-4 mt-1 text-xs text-gray-400",children:[(0,r.jsxs)("span",{children:["Split: ",(0,r.jsx)("b",{children:e.split_type})]}),(0,r.jsxs)("span",{children:["Status: ",(0,r.jsx)("b",{className:"completed"===e.status?"text-green-400":"text-yellow-400",children:e.status})]}),(null==(t=e.metrics_summary)?void 0:t.f1)!=null&&(0,r.jsxs)("span",{children:["F1: ",(0,r.jsxs)("b",{className:"text-yellow-400",children:[(100*e.metrics_summary.f1).toFixed(1),"%"]})]})]})]},e.run_id)}),0===N.length&&(0,r.jsx)("p",{className:"text-sm text-gray-500 text-center py-4",children:"No runs yet."})]})]})]}),"view"===u&&!s&&(0,r.jsxs)("div",{className:"text-center py-20",children:[(0,r.jsx)("p",{className:"text-gray-500 mb-4",children:"No detection selected."}),(0,r.jsx)("button",{onClick:W,className:"px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm",children:"Create Your First Detection"}),(0,r.jsxs)("div",{className:"mt-8 max-w-2xl mx-auto text-left bg-gray-800/50 border border-gray-700 rounded-lg p-6",children:[(0,r.jsx)("h3",{className:"text-sm font-semibold text-gray-300 mb-3",children:"Getting Started"}),(0,r.jsxs)("ol",{className:"list-decimal list-inside text-xs text-gray-400 space-y-2",children:[(0,r.jsx)("li",{children:"Set your Gemini API key using the button in the top-right corner"}),(0,r.jsx)("li",{children:"Create a detection with a stable code, label policy, and decision rubric"}),(0,r.jsx)("li",{children:"Create prompt versions with structured sections"}),(0,r.jsx)("li",{children:"Upload a dataset (JSON manifest with image_id, image_uri, ground_truth_label)"}),(0,r.jsx)("li",{children:"Run the initial iteration here to inspect outcomes and refine prompts"}),(0,r.jsx)("li",{children:"Use HIL Review to correct predictions and improve ground truth"}),(0,r.jsx)("li",{children:"Use Prompt Feedback to analyze errors and create improved prompt versions"}),(0,r.jsx)("li",{children:"Use Prompt Compare to compare baseline vs improved prompts"}),(0,r.jsx)("li",{children:"Run Held-Out Eval for final evaluation before approval"})]}),(0,r.jsxs)("div",{className:"mt-4 bg-gray-900 rounded p-3 text-xs font-mono text-gray-400",children:[(0,r.jsx)("p",{className:"text-gray-500 mb-1",children:"Dataset manifest format (JSON array):"}),'[\n  { "image_id": "img_001", "image_uri": "https://...", "ground_truth_label": "DETECTED" },\n  { "image_id": "img_002", "image_uri": "./path/to/image.jpg", "ground_truth_label": "NOT_DETECTED" }\n]']})]})]}),L&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6",onClick:()=>R(null),children:(0,r.jsx)("img",{src:L,alt:"Preview",className:"max-h-[90vh] max-w-[90vw] rounded-lg border border-gray-700"})})]})}function p(e){var t,s,l;let{detectionId:i,detectionCode:n,onSaved:d,initialData:c}=e,[o,x]=(0,a.useState)({version_label:(null==c?void 0:c.version_label)||"",system_prompt:(null==c?void 0:c.system_prompt)||"You are a visual detection system. Your task is to analyze images for a specific detection type and return a structured JSON response.\n\nYou must ONLY return valid JSON matching the exact schema provided. No markdown, no commentary, no extra text.",user_prompt_template:(null==c?void 0:c.user_prompt_template)||'Analyze this image for the detection: {{DETECTION_CODE}}\n\nReturn ONLY this JSON:\n{\n  "detection_code": "{{DETECTION_CODE}}",\n  "decision": "DETECTED" or "NOT_DETECTED",\n  "confidence": <float 0-1>,\n  "evidence": "<short phrase describing visual basis>"\n}',prompt_structure:(null==c?void 0:c.prompt_structure)||{detection_identity:"",label_policy:"",decision_rubric:"",output_schema:'{"detection_code":"'.concat(n,'","decision":"DETECTED|NOT_DETECTED","confidence":0.0,"evidence":"short phrase"}'),examples:""},model:(null==c?void 0:c.model)||"gemini-2.5-flash",temperature:null!=(t=null==c?void 0:c.temperature)?t:0,top_p:null!=(s=null==c?void 0:c.top_p)?s:1,max_output_tokens:null!=(l=null==c?void 0:c.max_output_tokens)?l:1024,change_notes:"",created_by:"user"}),p=async()=>{await fetch("/api/prompts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...o,detection_id:i})}),d()};return(0,r.jsxs)("div",{className:"border border-gray-600 rounded-lg p-4 mb-4 space-y-3 bg-gray-900/50",children:[(0,r.jsxs)("div",{className:"grid grid-cols-4 gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Version Label"}),(0,r.jsx)("input",{className:"w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-sm",value:o.version_label,onChange:e=>x({...o,version_label:e.target.value}),placeholder:"v1.1"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Model"}),(0,r.jsxs)("select",{className:"w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-sm",value:o.model,onChange:e=>x({...o,model:e.target.value}),children:[(0,r.jsx)("option",{value:"gemini-2.5-flash",children:"gemini-2.5-flash"}),(0,r.jsx)("option",{value:"gemini-2.5-pro",children:"gemini-2.5-pro"}),(0,r.jsx)("option",{value:"gemini-2.0-flash",children:"gemini-2.0-flash"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Temperature"}),(0,r.jsx)("input",{type:"number",step:"0.1",min:"0",max:"2",className:"w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-sm",value:o.temperature,onChange:e=>x({...o,temperature:parseFloat(e.target.value)||0})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Max Tokens"}),(0,r.jsx)("input",{type:"number",className:"w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-sm",value:o.max_output_tokens,onChange:e=>x({...o,max_output_tokens:parseInt(e.target.value)||1024})})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"System Prompt"}),(0,r.jsx)("textarea",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm font-mono h-24",value:o.system_prompt,onChange:e=>x({...o,system_prompt:e.target.value})})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"text-xs text-gray-400 block mb-1",children:["User Prompt Template ",(0,r.jsxs)("span",{className:"text-gray-600",children:["(use ","{{DETECTION_CODE}}"," as placeholder)"]})]}),(0,r.jsx)("textarea",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm font-mono h-40",value:o.user_prompt_template,onChange:e=>x({...o,user_prompt_template:e.target.value})})]}),(0,r.jsxs)("details",{className:"text-sm",children:[(0,r.jsx)("summary",{className:"text-xs text-gray-400 cursor-pointer hover:text-gray-300",children:"Structured Prompt Sections (optional)"}),(0,r.jsx)("div",{className:"mt-2 space-y-2",children:["detection_identity","label_policy","decision_rubric","output_schema","examples"].map(e=>(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-500 block mb-1",children:e.replace(/_/g," ")}),(0,r.jsx)("textarea",{className:"w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-xs font-mono h-16",value:o.prompt_structure[e]||"",onChange:t=>x({...o,prompt_structure:{...o.prompt_structure,[e]:t.target.value}})})]},e))})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Change Notes"}),(0,r.jsx)("input",{className:"w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-sm",value:o.change_notes,onChange:e=>x({...o,change_notes:e.target.value})})]}),(0,r.jsx)("button",{onClick:p,className:"px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm",children:"Save Prompt Version"})]})}function m(e){let{detectionId:t,onUploaded:s}=e,[l,i]=(0,a.useState)(""),[n,d]=(0,a.useState)("ITERATION"),[c,o]=(0,a.useState)(""),[x,p]=(0,a.useState)(""),m=async()=>{p("");try{let e=JSON.parse(c);if(!Array.isArray(e))return void p("Must be a JSON array");for(let t of e)if(!t.image_id||!t.image_uri||!["DETECTED","NOT_DETECTED"].includes(t.ground_truth_label))return void p("Each item must have image_id, image_uri, and ground_truth_label (DETECTED|NOT_DETECTED)");await fetch("/api/datasets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:l,detection_id:t,split_type:n,items:e})}),s()}catch(e){p("Invalid JSON format")}};return(0,r.jsxs)("div",{className:"border border-gray-600 rounded-lg p-4 mb-4 space-y-3 bg-gray-900/50",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Dataset Name"}),(0,r.jsx)("input",{className:"w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-sm",value:l,onChange:e=>i(e.target.value),placeholder:"My Dataset"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Split Type"}),(0,r.jsxs)("select",{className:"w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-sm",value:n,onChange:e=>d(e.target.value),children:[(0,r.jsx)("option",{value:"GOLDEN",children:"GOLDEN (regression gate)"}),(0,r.jsx)("option",{value:"ITERATION",children:"ITERATION (can be corrected via HIL)"}),(0,r.jsx)("option",{value:"HELD_OUT_EVAL",children:"HELD_OUT_EVAL (protected, final eval)"}),(0,r.jsx)("option",{value:"CUSTOM",children:"CUSTOM"})]})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Dataset Manifest (JSON array)"}),(0,r.jsx)("textarea",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-xs font-mono h-32",value:c,onChange:e=>o(e.target.value),placeholder:'[\n  { "image_id": "img_001", "image_uri": "https://example.com/image1.jpg", "ground_truth_label": "DETECTED" },\n  { "image_id": "img_002", "image_uri": "https://example.com/image2.jpg", "ground_truth_label": "NOT_DETECTED" }\n]'})]}),x&&(0,r.jsx)("p",{className:"text-xs text-red-400",children:x}),(0,r.jsx)("button",{onClick:m,className:"px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm",children:"Upload Dataset"})]})}function h(e){let{detection:t}=e,{apiKey:s,selectedModel:l}=n(),[i,d]=(0,a.useState)([]),[o,x]=(0,a.useState)([]),[p,m]=(0,a.useState)([]),[h,y]=(0,a.useState)(""),[j,_]=(0,a.useState)(!1),[N,v]=(0,a.useState)(""),[f,E]=(0,a.useState)(new Map),w=(0,a.useCallback)(async()=>{let[e,s]=await Promise.all([fetch("/api/prompts?detection_id=".concat(t.detection_id)),fetch("/api/datasets?detection_id=".concat(t.detection_id))]),r=await e.json(),a=await s.json();d(r),x(a.filter(e=>"GOLDEN"===e.split_type||"ITERATION"===e.split_type||"CUSTOM"===e.split_type))},[t.detection_id]);(0,a.useEffect)(()=>{w()},[w]);let T=async()=>{if(!s)return void alert("Set your Gemini API key first");if(p.length<1)return void alert("Select at least 1 prompt version");if(!h)return void alert("Select a dataset");_(!0),E(new Map);for(let e=0;e<p.length;e++){let r=p[e],a=i.find(e=>e.prompt_version_id===r);v("Running prompt ".concat(e+1,"/").concat(p.length,": ").concat((null==a?void 0:a.version_label)||r.slice(0,8),"..."));try{let e=await fetch("/api/runs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:s,model_override:l,prompt_version_id:r,dataset_id:h,detection_id:t.detection_id})}),a=await e.json(),i=await fetch("/api/runs?run_id=".concat(a.run_id)),n=await i.json();E(e=>{let t=new Map(e);return t.set(r,{run:n,predictions:n.predictions}),t})}catch(e){console.error("Run failed:",e)}}_(!1),v("")},D=Array.from(f.entries()),C=new Map;if(D.length>=2){let e=new Set;for(let[,{predictions:t}]of D)for(let s of t)e.add(s.image_id);for(let t of e){let e=new Map;for(let[s,{predictions:r}]of D){let a=r.find(e=>e.image_id===t);e.set(s,(null==a?void 0:a.predicted_decision)||null)}new Set(Array.from(e.values())).size>1&&C.set(t,e)}}return(0,r.jsxs)("div",{className:"max-w-7xl mx-auto space-y-6",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"Prompt Compare"}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-xs text-gray-400 font-medium mb-2",children:"Select 2–4 Prompt Versions"}),(0,r.jsx)("div",{className:"space-y-1.5 max-h-48 overflow-y-auto",children:i.map(e=>(0,r.jsxs)("label",{className:"flex items-center gap-2 p-2 rounded border cursor-pointer text-sm ".concat(p.includes(e.prompt_version_id)?"border-blue-600 bg-blue-900/20":"border-gray-700 bg-gray-900/30 hover:border-gray-600"),children:[(0,r.jsx)("input",{type:"checkbox",checked:p.includes(e.prompt_version_id),onChange:()=>{var t;return t=e.prompt_version_id,void m(e=>e.includes(t)?e.filter(e=>e!==t):e.length>=4?e:[...e,t])},className:"rounded"}),(0,r.jsx)("span",{children:e.version_label}),(0,r.jsxs)("span",{className:"text-xs text-gray-500",children:[e.model," | temp=",e.temperature]}),e.prompt_version_id===t.approved_prompt_version&&(0,r.jsx)("span",{className:"text-xs text-green-400 ml-auto",children:"APPROVED"})]},e.prompt_version_id))})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-xs text-gray-400 font-medium mb-2",children:"Select Dataset"}),(0,r.jsx)("div",{className:"space-y-1.5",children:o.map(e=>(0,r.jsxs)("label",{className:"flex items-center gap-2 p-2 rounded border cursor-pointer text-sm ".concat(h===e.dataset_id?"border-blue-600 bg-blue-900/20":"border-gray-700 bg-gray-900/30 hover:border-gray-600"),children:[(0,r.jsx)("input",{type:"radio",name:"dataset",checked:h===e.dataset_id,onChange:()=>y(e.dataset_id)}),(0,r.jsx)("span",{children:e.name}),(0,r.jsxs)("span",{className:"text-xs text-gray-500",children:[e.size," images"]}),(0,r.jsx)("span",{className:"text-xs ml-auto px-1.5 py-0.5 rounded ".concat(function(e){switch(e){case"GOLDEN":return"bg-yellow-900/30 text-yellow-400";case"ITERATION":return"bg-blue-900/30 text-blue-400";case"HELD_OUT_EVAL":return"bg-purple-900/30 text-purple-400";default:return"bg-gray-800 text-gray-400"}}(e.split_type)),children:e.split_type})]},e.dataset_id))}),(0,r.jsxs)("div",{className:"mt-3 p-2 bg-gray-900/50 rounded border border-gray-700 text-xs text-gray-400",children:[(0,r.jsx)("b",{children:"Locked params:"})," All prompts will run with the same dataset and images. Temperature/top_p stay per-prompt. Model uses the app-level selection."]})]})]}),(0,r.jsxs)("div",{className:"mt-4 flex items-center gap-4",children:[(0,r.jsx)("button",{onClick:T,disabled:j||p.length<1||!h,className:"px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm font-medium",children:j?"Running...":"Run Comparison"}),N&&(0,r.jsx)("span",{className:"text-sm text-gray-400",children:N})]})]}),D.length>0&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:D.map(e=>{let[t,{run:s}]=e,a=i.find(e=>e.prompt_version_id===t);return(0,r.jsx)(c,{metrics:s.metrics_summary,label:"".concat((null==a?void 0:a.version_label)||t.slice(0,8)," — ").concat(null==a?void 0:a.model)},t)})}),D.length>=2&&(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsx)("h3",{className:"text-sm font-medium mb-3",children:"Metric Deltas (vs first prompt)"}),(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full text-sm",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{className:"text-xs text-gray-500 border-b border-gray-700",children:[(0,r.jsx)("th",{className:"text-left py-2 px-3",children:"Prompt"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"Precision"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"Recall"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"F1"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"Accuracy"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"Parse Fail %"})]})}),(0,r.jsx)("tbody",{children:D.map((e,t)=>{let[s,{run:a}]=e,l=i.find(e=>e.prompt_version_id===s),n=a.metrics_summary,d=D[0][1].run.metrics_summary,c=0===t;return(0,r.jsxs)("tr",{className:"border-b border-gray-800",children:[(0,r.jsxs)("td",{className:"py-2 px-3 font-medium",children:[null==l?void 0:l.version_label,c&&(0,r.jsx)("span",{className:"text-xs text-gray-500 ml-1",children:"(baseline)"})]}),(0,r.jsxs)("td",{className:"text-right py-2 px-3",children:[b(n.precision),!c&&(0,r.jsx)(g,{value:n.precision-d.precision})]}),(0,r.jsxs)("td",{className:"text-right py-2 px-3",children:[b(n.recall),!c&&(0,r.jsx)(g,{value:n.recall-d.recall})]}),(0,r.jsxs)("td",{className:"text-right py-2 px-3",children:[b(n.f1),!c&&(0,r.jsx)(g,{value:n.f1-d.f1})]}),(0,r.jsxs)("td",{className:"text-right py-2 px-3",children:[b(n.accuracy),!c&&(0,r.jsx)(g,{value:n.accuracy-d.accuracy})]}),(0,r.jsx)("td",{className:"text-right py-2 px-3",children:b(n.parse_failure_rate)})]},s)})})]})})]}),C.size>0&&(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsxs)("h3",{className:"text-sm font-medium mb-3",children:["Disagreement Cases (",C.size," images)"]}),(0,r.jsx)("div",{className:"overflow-x-auto max-h-96 overflow-y-auto",children:(0,r.jsxs)("table",{className:"w-full text-xs",children:[(0,r.jsx)("thead",{className:"sticky top-0 bg-gray-800",children:(0,r.jsxs)("tr",{className:"text-gray-500 border-b border-gray-700",children:[(0,r.jsx)("th",{className:"text-left py-2 px-3",children:"Image ID"}),D.map(e=>{let[t]=e,s=i.find(e=>e.prompt_version_id===t);return(0,r.jsx)("th",{className:"text-center py-2 px-3",children:null==s?void 0:s.version_label},t)})]})}),(0,r.jsx)("tbody",{children:Array.from(C.entries()).map(e=>{let[t,s]=e;return(0,r.jsxs)("tr",{className:"border-b border-gray-800",children:[(0,r.jsx)("td",{className:"py-2 px-3 font-mono",children:t}),D.map(e=>{let[t]=e,a=s.get(t);return(0,r.jsx)("td",{className:"text-center py-2 px-3",children:(0,r.jsx)("span",{className:"px-1.5 py-0.5 rounded text-xs ".concat("DETECTED"===a?"bg-green-900/30 text-green-400":"NOT_DETECTED"===a?"bg-gray-800 text-gray-400":"bg-red-900/30 text-red-400"),children:a||"PARSE_FAIL"})},t)})]},t)})})]})})]}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsx)("h3",{className:"text-sm font-medium mb-3",children:"Full Outcomes"}),D.map(e=>{let[t,{predictions:s}]=e,a=i.find(e=>e.prompt_version_id===t);return(0,r.jsxs)("details",{className:"mb-3",children:[(0,r.jsxs)("summary",{className:"cursor-pointer text-sm text-gray-300 hover:text-white",children:[null==a?void 0:a.version_label," — ",s.length," predictions"]}),(0,r.jsx)("div",{className:"mt-2 overflow-x-auto max-h-72 overflow-y-auto",children:(0,r.jsxs)("table",{className:"w-full text-xs",children:[(0,r.jsx)("thead",{className:"sticky top-0 bg-gray-800",children:(0,r.jsxs)("tr",{className:"text-gray-500 border-b border-gray-700",children:[(0,r.jsx)("th",{className:"text-left py-1.5 px-2",children:"Image"}),(0,r.jsx)("th",{className:"text-center py-1.5 px-2",children:"Ground Truth"}),(0,r.jsx)("th",{className:"text-center py-1.5 px-2",children:"Prediction"}),(0,r.jsx)("th",{className:"text-center py-1.5 px-2",children:"Correct"}),(0,r.jsx)("th",{className:"text-right py-1.5 px-2",children:"Confidence"}),(0,r.jsx)("th",{className:"text-left py-1.5 px-2",children:"Evidence"}),(0,r.jsx)("th",{className:"text-center py-1.5 px-2",children:"Parse"})]})}),(0,r.jsx)("tbody",{children:s.map(e=>{let t=e.parse_ok&&e.predicted_decision===e.ground_truth_label;return(0,r.jsxs)("tr",{className:"border-b border-gray-800/50",children:[(0,r.jsx)("td",{className:"py-1.5 px-2 font-mono",children:e.image_id}),(0,r.jsx)("td",{className:"text-center py-1.5 px-2",children:(0,r.jsx)(u,{decision:e.ground_truth_label})}),(0,r.jsx)("td",{className:"text-center py-1.5 px-2",children:(0,r.jsx)(u,{decision:e.predicted_decision})}),(0,r.jsx)("td",{className:"text-center py-1.5 px-2",children:t?(0,r.jsx)("span",{className:"text-green-400",children:"✓"}):(0,r.jsx)("span",{className:"text-red-400",children:"✗"})}),(0,r.jsx)("td",{className:"text-right py-1.5 px-2",children:null!=e.confidence?e.confidence.toFixed(2):"—"}),(0,r.jsx)("td",{className:"py-1.5 px-2 text-gray-400 max-w-[200px] truncate",children:e.evidence||"—"}),(0,r.jsx)("td",{className:"text-center py-1.5 px-2",children:e.parse_ok?(0,r.jsx)("span",{className:"text-green-400 text-xs",children:"OK"}):(0,r.jsx)("span",{className:"text-red-400 text-xs",children:"FAIL"})})]},e.prediction_id)})})]})})]},t)})]})]})]})}function u(e){let{decision:t}=e;return t?(0,r.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded ".concat("DETECTED"===t?"bg-green-900/30 text-green-400":"bg-gray-800 text-gray-400"),children:"DETECTED"===t?"DET":"NOT"}):(0,r.jsx)("span",{className:"text-gray-600 text-xs",children:"—"})}function g(e){let{value:t}=e,s=(100*t).toFixed(1);return(0,r.jsxs)("span",{className:"ml-1 text-xs ".concat(t>0?"text-green-400":t<0?"text-red-400":"text-gray-500"),children:["(",t>0?"+":"",s,")"]})}function b(e){return(100*e).toFixed(1)+"%"}let y=["MISSED_DETECTION","FALSE_POSITIVE","AMBIGUOUS_IMAGE","LABEL_POLICY_GAP","PROMPT_INSTRUCTION_GAP","SCHEMA_VIOLATION"];function j(e){let{detection:t}=e,{selectedRunByDetection:s,setSelectedRunForDetection:l}=n(),[i,d]=(0,a.useState)([]),c=s[t.detection_id]||"",[o,x]=(0,a.useState)(c),[p,m]=(0,a.useState)([]),[h,u]=(0,a.useState)("all"),[g,b]=(0,a.useState)("table"),[y,j]=(0,a.useState)(0),[v,f]=(0,a.useState)(null),E=(0,a.useCallback)(async()=>{let e=await fetch("/api/runs?detection_id=".concat(t.detection_id));d((await e.json()).filter(e=>"completed"===e.status))},[t.detection_id]);(0,a.useEffect)(()=>{E()},[E]),(0,a.useEffect)(()=>{x(c)},[c]);let w=(0,a.useCallback)(async()=>{if(!o)return;let e=await fetch("/api/runs?run_id=".concat(o)),t=await e.json();f(t),m(t.predictions||[]),j(0)},[o]);(0,a.useEffect)(()=>{w()},[w]),(0,a.useEffect)(()=>{o&&l(t.detection_id,o)},[o,t.detection_id,l]);let T=p.filter(e=>{let t=e.corrected_label||e.ground_truth_label;switch(h){case"fp":return e.parse_ok&&"DETECTED"===e.predicted_decision&&"NOT_DETECTED"===t;case"fn":return e.parse_ok&&"NOT_DETECTED"===e.predicted_decision&&"DETECTED"===t;case"parse_fail":return!e.parse_ok;case"correct":return e.parse_ok&&e.predicted_decision===t;case"corrected":return null!==e.corrected_label;default:return!0}}),D=async(e,t)=>{var s;await fetch("/api/hil",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({prediction_id:e,...t,update_ground_truth:null!=(s=t.update_ground_truth)?s:(null==v?void 0:v.split_type)==="ITERATION"})}),m(s=>s.map(s=>s.prediction_id===e?{...s,corrected_label:void 0!==t.corrected_label?t.corrected_label:s.corrected_label,error_tag:void 0!==t.error_tag?t.error_tag:s.error_tag,reviewer_note:void 0!==t.reviewer_note?t.reviewer_note:s.reviewer_note,corrected_at:new Date().toISOString()}:s))},C=T[y];return(0,r.jsxs)("div",{className:"max-w-7xl mx-auto space-y-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"Human-in-the-Loop Review"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>b("table"),className:"px-3 py-1.5 text-sm rounded ".concat("table"===g?"bg-blue-600":"bg-gray-700 hover:bg-gray-600"),children:"Table View"}),(0,r.jsx)("button",{onClick:()=>b("image"),className:"px-3 py-1.5 text-sm rounded ".concat("image"===g?"bg-blue-600":"bg-gray-700 hover:bg-gray-600"),children:"Image Review"})]})]}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsx)("label",{className:"text-xs text-gray-400",children:"Select Run:"}),(0,r.jsxs)("select",{className:"bg-gray-900 border border-gray-600 rounded px-3 py-1.5 text-sm flex-1",value:o,onChange:e=>{let s=e.target.value;x(s),s&&l(t.detection_id,s)},children:[(0,r.jsx)("option",{value:"",children:"Choose a run..."}),i.map(e=>{var t;return(0,r.jsxs)("option",{value:e.run_id,children:[e.run_id.slice(0,8)," — ",e.split_type," — F1: ",(100*((null==(t=e.metrics_summary)?void 0:t.f1)||0)).toFixed(1),"% — ",new Date(e.created_at).toLocaleString()]},e.run_id)})]})]}),p.length>0&&(0,r.jsx)("div",{className:"flex gap-2 mt-3",children:[["all","All"],["fp","False Positives"],["fn","False Negatives"],["parse_fail","Parse Failures"],["correct","Correct"],["corrected","Corrected"]].map(e=>{let[t,s]=e,a=p.filter(e=>{let s=e.corrected_label||e.ground_truth_label;switch(t){case"fp":return e.parse_ok&&"DETECTED"===e.predicted_decision&&"NOT_DETECTED"===s;case"fn":return e.parse_ok&&"NOT_DETECTED"===e.predicted_decision&&"DETECTED"===s;case"parse_fail":return!e.parse_ok;case"correct":return e.parse_ok&&e.predicted_decision===s;case"corrected":return null!==e.corrected_label;default:return!0}}).length;return(0,r.jsxs)("button",{onClick:()=>{u(t),j(0)},className:"px-3 py-1 text-xs rounded-full ".concat(h===t?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"),children:[s," (",a,")"]},t)})})]}),"table"===g&&T.length>0&&(0,r.jsx)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg overflow-hidden",children:(0,r.jsx)("div",{className:"overflow-x-auto max-h-[600px] overflow-y-auto",children:(0,r.jsxs)("table",{className:"w-full text-sm",children:[(0,r.jsx)("thead",{className:"sticky top-0 bg-gray-800 z-10",children:(0,r.jsxs)("tr",{className:"text-xs text-gray-500 border-b border-gray-700",children:[(0,r.jsx)("th",{className:"text-left py-2.5 px-3",children:"Image"}),(0,r.jsx)("th",{className:"text-left py-2.5 px-3",children:"Thumbnail"}),(0,r.jsx)("th",{className:"text-center py-2.5 px-3",children:"Predicted"}),(0,r.jsx)("th",{className:"text-center py-2.5 px-3",children:"Ground Truth"}),(0,r.jsx)("th",{className:"text-center py-2.5 px-3",children:"Corrected?"}),(0,r.jsx)("th",{className:"text-center py-2.5 px-3",children:"Error Tag"}),(0,r.jsx)("th",{className:"text-right py-2.5 px-3",children:"Confidence"}),(0,r.jsx)("th",{className:"text-center py-2.5 px-3",children:"Parse"}),(0,r.jsx)("th",{className:"text-center py-2.5 px-3",children:"Actions"})]})}),(0,r.jsx)("tbody",{children:T.map((e,t)=>(0,r.jsx)(_,{prediction:e,onUpdate:D,onImageReview:()=>{j(t),b("image")},isIteration:(null==v?void 0:v.split_type)==="ITERATION"},e.prediction_id))})]})})}),"image"===g&&C&&(0,r.jsx)(N,{prediction:C,index:y,total:T.length,onNext:()=>j(e=>Math.min(e+1,T.length-1)),onPrev:()=>j(e=>Math.max(e-1,0)),onUpdate:D,isIteration:(null==v?void 0:v.split_type)==="ITERATION"}),p.length>0&&0===T.length&&(0,r.jsx)("p",{className:"text-center text-gray-500 py-8",children:"No predictions match the selected filter."}),!o&&(0,r.jsx)("p",{className:"text-center text-gray-500 py-8",children:"Select a completed run to begin review."})]})}function _(e){let{prediction:t,onUpdate:s,onImageReview:a,isIteration:l}=e,i=t.corrected_label||t.ground_truth_label,n=t.parse_ok&&t.predicted_decision===i;return(0,r.jsxs)("tr",{className:"border-b border-gray-800/50 hover:bg-gray-800/30 ".concat(n?"":"bg-red-900/5"),children:[(0,r.jsx)("td",{className:"py-2 px-3 font-mono text-xs",children:t.image_id}),(0,r.jsx)("td",{className:"py-2 px-3",children:(0,r.jsx)("img",{src:t.image_uri,alt:t.image_id,className:"w-10 h-10 object-cover rounded cursor-pointer hover:opacity-80",onClick:a})}),(0,r.jsx)("td",{className:"text-center py-2 px-3",children:(0,r.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded ".concat("DETECTED"===t.predicted_decision?"bg-green-900/30 text-green-400":"NOT_DETECTED"===t.predicted_decision?"bg-gray-800 text-gray-400":"bg-red-900/30 text-red-400"),children:t.predicted_decision||"PARSE_FAIL"})}),(0,r.jsx)("td",{className:"text-center py-2 px-3",children:(0,r.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded ".concat("DETECTED"===t.ground_truth_label?"bg-green-900/30 text-green-400":"bg-gray-800 text-gray-400"),children:"DETECTED"===t.ground_truth_label?"DET":"NOT"})}),(0,r.jsx)("td",{className:"text-center py-2 px-3",children:t.corrected_label?(0,r.jsx)("span",{className:"text-xs text-yellow-400",children:"DETECTED"===t.corrected_label?"→DET":"→NOT"}):(0,r.jsx)("span",{className:"text-gray-600 text-xs",children:"—"})}),(0,r.jsx)("td",{className:"text-center py-2 px-3",children:(0,r.jsxs)("select",{className:"bg-gray-900 border border-gray-700 rounded text-xs px-1 py-0.5",value:t.error_tag||"",onChange:e=>s(t.prediction_id,{error_tag:e.target.value||null}),children:[(0,r.jsx)("option",{value:"",children:"—"}),y.map(e=>(0,r.jsx)("option",{value:e,children:e},e))]})}),(0,r.jsx)("td",{className:"text-right py-2 px-3 text-xs",children:null!=t.confidence?t.confidence.toFixed(2):"—"}),(0,r.jsx)("td",{className:"text-center py-2 px-3",children:t.parse_ok?(0,r.jsx)("span",{className:"text-green-400 text-xs",children:"OK"}):(0,r.jsx)("span",{className:"text-red-400 text-xs",children:"FAIL"})}),(0,r.jsx)("td",{className:"text-center py-2 px-3",children:(0,r.jsx)("button",{onClick:a,className:"text-xs text-blue-400 hover:text-blue-300",children:"Review"})})]})}function N(e){let{prediction:t,index:s,total:l,onNext:i,onPrev:n,onUpdate:d,isIteration:c}=e,[o,x]=(0,a.useState)(t.reviewer_note||"");return(0,a.useEffect)(()=>{x(t.reviewer_note||"")},[t.prediction_id,t.reviewer_note]),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-6",onKeyDown:e=>{("ArrowRight"===e.key||"n"===e.key)&&i(),("ArrowLeft"===e.key||"p"===e.key)&&n()},tabIndex:0,children:[(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-4",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-3",children:[(0,r.jsxs)("span",{className:"text-xs text-gray-500",children:[s+1," / ",l," — ",t.image_id]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:n,disabled:0===s,className:"px-2 py-1 bg-gray-700 hover:bg-gray-600 disabled:opacity-30 rounded text-xs",children:"← Prev"}),(0,r.jsx)("button",{onClick:i,disabled:s===l-1,className:"px-2 py-1 bg-gray-700 hover:bg-gray-600 disabled:opacity-30 rounded text-xs",children:"Next →"})]})]}),(0,r.jsx)("img",{src:t.image_uri,alt:t.image_id,className:"w-full max-h-[500px] object-contain rounded bg-gray-900"})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-4",children:[(0,r.jsx)("h4",{className:"text-xs text-gray-500 font-medium mb-2",children:"Model Response"}),(0,r.jsx)("pre",{className:"text-xs font-mono bg-gray-900 rounded p-3 overflow-x-auto whitespace-pre-wrap text-gray-300",children:t.raw_response}),!t.parse_ok&&(0,r.jsx)("p",{className:"text-xs text-red-400 mt-2",children:"Parse failed — response did not match expected schema"})]}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-4",children:[(0,r.jsx)("h4",{className:"text-xs text-gray-500 font-medium mb-2",children:"Label Correction"}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("span",{className:"text-xs text-gray-400",children:"Ground truth:"}),(0,r.jsx)("span",{className:"text-sm font-medium ".concat("DETECTED"===t.ground_truth_label?"text-green-400":"text-gray-400"),children:t.ground_truth_label})]}),t.corrected_label&&(0,r.jsxs)("div",{className:"flex items-center gap-3 mt-1",children:[(0,r.jsx)("span",{className:"text-xs text-gray-400",children:"Corrected to:"}),(0,r.jsx)("span",{className:"text-sm font-medium ".concat("DETECTED"===t.corrected_label?"text-green-400":"text-gray-400"),children:t.corrected_label})]}),(0,r.jsxs)("button",{onClick:()=>{let e="DETECTED"===(t.corrected_label||t.ground_truth_label)?"NOT_DETECTED":"DETECTED";d(t.prediction_id,{corrected_label:e})},className:"mt-3 px-4 py-2 bg-yellow-600 hover:bg-yellow-500 rounded text-sm",children:["Toggle → ","DETECTED"===(t.corrected_label||t.ground_truth_label)?"NOT_DETECTED":"DETECTED"]}),c&&(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Corrections will update ground truth for ITERATION datasets."}),t.corrected_label&&(0,r.jsx)("button",{onClick:()=>d(t.prediction_id,{corrected_label:null}),className:"mt-2 text-xs text-gray-500 hover:text-gray-300 underline",children:"Reset correction"})]}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-4",children:[(0,r.jsx)("h4",{className:"text-xs text-gray-500 font-medium mb-2",children:"Error Tag"}),(0,r.jsxs)("select",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm",value:t.error_tag||"",onChange:e=>d(t.prediction_id,{error_tag:e.target.value||null}),children:[(0,r.jsx)("option",{value:"",children:"No tag"}),y.map(e=>(0,r.jsx)("option",{value:e,children:e},e))]})]}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-4",children:[(0,r.jsx)("h4",{className:"text-xs text-gray-500 font-medium mb-2",children:"Reviewer Note"}),(0,r.jsx)("textarea",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm h-20",value:o,onChange:e=>x(e.target.value),placeholder:"Add observations..."}),(0,r.jsx)("button",{onClick:()=>d(t.prediction_id,{reviewer_note:o||null}),className:"mt-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs",children:"Save Note"})]}),(0,r.jsxs)("div",{className:"text-xs text-gray-500 space-y-0.5",children:[(0,r.jsxs)("p",{children:["Confidence: ",null!=t.confidence?t.confidence.toFixed(3):"N/A"," (uncalibrated)"]}),(0,r.jsxs)("p",{children:["Evidence: ",t.evidence||"—"]}),(0,r.jsxs)("p",{children:["Prediction: ",t.predicted_decision||"PARSE_FAIL"]})]})]})]})}function v(e){let{detection:t}=e,{apiKey:s,selectedModel:l,selectedRunByDetection:i,setSelectedRunForDetection:d}=n(),[o,x]=(0,a.useState)([]),p=i[t.detection_id]||"",[m,h]=(0,a.useState)(p),[u,g]=(0,a.useState)(null),[b,y]=(0,a.useState)(null),[j,_]=(0,a.useState)([]),[N,v]=(0,a.useState)([]),[f,E]=(0,a.useState)(!1),[w,T]=(0,a.useState)(new Set),[D,C]=(0,a.useState)(!1),S=(0,a.useCallback)(async()=>{let[e,s]=await Promise.all([fetch("/api/runs?detection_id=".concat(t.detection_id)),fetch("/api/prompts?detection_id=".concat(t.detection_id))]);x((await e.json()).filter(e=>"completed"===e.status)),_(await s.json())},[t.detection_id]);(0,a.useEffect)(()=>{S()},[S]),(0,a.useEffect)(()=>{h(p)},[p]);let k=(0,a.useCallback)(async()=>{if(!m)return;let e=await fetch("/api/runs?run_id=".concat(m));g(await e.json()),y(null),v([])},[m]);(0,a.useEffect)(()=>{k()},[k]),(0,a.useEffect)(()=>{m&&d(t.detection_id,m)},[m,t.detection_id,d]);let O=async()=>{if(!m)return;let e=await fetch("/api/hil",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({run_id:m})});y((await e.json()).metrics)},P=async()=>{if(!s)return void alert("Set your Gemini API key first");if(!u)return;E(!0);let e=j.find(e=>e.prompt_version_id===u.prompt_version_id);if(!e)return void E(!1);try{let r=await fetch("/api/gemini",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:s,model_override:l,predictions:u.predictions,prompt:e,detection:t})}),a=await r.json();a.suggestions?v(a.suggestions):alert(a.error||"Failed to get suggestions")}catch(e){console.error(e)}E(!1)},A=e=>{T(t=>{let s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})},I=async()=>{if(0===w.size||!u)return;let e=j.find(e=>e.prompt_version_id===u.prompt_version_id);if(!e)return;C(!0);let r=e.system_prompt,a=e.user_prompt_template;for(let e of w){let t=N[e];"system_prompt"===t.section?r=r.replace(t.old_text,t.new_text):a=a.replace(t.old_text,t.new_text)}let i=j.length+1,n=Array.from(w).map(e=>N[e].rationale).join("; ");try{let o=await fetch("/api/prompts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({detection_id:t.detection_id,version_label:"v".concat(i,".0"),system_prompt:r,user_prompt_template:a,prompt_structure:e.prompt_structure,model:e.model,temperature:e.temperature,top_p:e.top_p,max_output_tokens:e.max_output_tokens,change_notes:"AI-suggested edits: ".concat(n),created_by:"ai-assistant"})}),x=await o.json(),p=await fetch("/api/datasets?detection_id=".concat(t.detection_id)),m=(await p.json()).find(e=>"GOLDEN"===e.split_type);if(m&&s){var d,c;let e=await fetch("/api/runs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:s,model_override:l,prompt_version_id:x.prompt_version_id,dataset_id:m.dataset_id,detection_id:t.detection_id})}),r=await e.json(),a=t.metric_thresholds,i=(d=r.metrics,c=a,(null==c.min_precision||!(d.precision<c.min_precision))&&(null==c.min_recall||!(d.recall<c.min_recall))&&(null==c.min_f1||!(d.f1<c.min_f1)));await fetch("/api/prompts",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt_version_id:x.prompt_version_id,golden_set_regression_result:{passed:i,run_id:r.run_id,metrics:r.metrics,previous_metrics:b||(null==u?void 0:u.metrics_summary),evaluated_at:new Date().toISOString()}})}),alert("New prompt version saved. Golden regression: ".concat(i?"PASSED":"FAILED"))}else alert("New prompt version saved. No golden dataset found for regression.");S()}catch(e){console.error(e)}C(!1)},L=b||(null==u?void 0:u.metrics_summary);return(0,r.jsxs)("div",{className:"max-w-7xl mx-auto space-y-6",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"Post-HIL Metrics & Prompt Improvement"}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsx)("label",{className:"text-xs text-gray-400",children:"Select Run:"}),(0,r.jsxs)("select",{className:"bg-gray-900 border border-gray-600 rounded px-3 py-1.5 text-sm flex-1",value:m,onChange:e=>{let s=e.target.value;h(s),s&&d(t.detection_id,s)},children:[(0,r.jsx)("option",{value:"",children:"Choose a run..."}),o.map(e=>(0,r.jsxs)("option",{value:e.run_id,children:[e.run_id.slice(0,8)," — ",e.split_type," — ",new Date(e.created_at).toLocaleString()]},e.run_id))]}),(0,r.jsx)("button",{onClick:O,disabled:!m,className:"px-4 py-1.5 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 rounded text-sm",children:"Recompute Metrics"})]}),b&&(0,r.jsx)("p",{className:"text-xs text-green-400 mt-2",children:"Metrics recomputed with HIL corrections applied."})]}),L&&(0,r.jsx)(c,{metrics:L,label:b?"Recomputed Metrics (Post-HIL)":"Original Run Metrics"}),u&&(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsx)("h3",{className:"text-sm font-medium",children:"Prompt Improvement Assistant"}),(0,r.jsx)("button",{onClick:P,disabled:f,className:"px-4 py-1.5 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 rounded text-sm",children:f?"Analyzing...":"Analyze Errors & Suggest Edits"})]}),(0,r.jsx)("p",{className:"text-xs text-gray-400 mb-4",children:"The assistant will analyze clustered FPs, FNs, error tags, and representative correct predictions to propose up to 5 targeted prompt edits. It will not rewrite the entire prompt or change the output schema."}),N.length>0&&(0,r.jsxs)("div",{className:"space-y-3",children:[N.map((e,t)=>(0,r.jsx)("div",{className:"border rounded-lg p-4 cursor-pointer transition-colors ".concat(w.has(t)?"border-purple-600 bg-purple-900/10":"border-gray-700 bg-gray-900/30 hover:border-gray-600"),onClick:()=>A(t),children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("input",{type:"checkbox",checked:w.has(t),onChange:()=>A(t),className:"mt-1"}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex gap-2 items-center mb-2",children:[(0,r.jsx)("span",{className:"text-xs bg-gray-800 px-2 py-0.5 rounded text-gray-400",children:e.section}),(0,r.jsxs)("span",{className:"text-xs text-gray-500",children:["→ ",e.failure_cluster]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-3 text-xs font-mono",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-red-400 text-xs font-sans",children:"OLD:"}),(0,r.jsx)("div",{className:"bg-red-900/10 border border-red-900/30 rounded p-2 mt-1 whitespace-pre-wrap text-red-300",children:e.old_text})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-green-400 text-xs font-sans",children:"NEW:"}),(0,r.jsx)("div",{className:"bg-green-900/10 border border-green-900/30 rounded p-2 mt-1 whitespace-pre-wrap text-green-300",children:e.new_text})]})]}),(0,r.jsx)("p",{className:"text-xs text-gray-400 mt-2",children:e.rationale})]})]})},t)),(0,r.jsxs)("div",{className:"flex gap-3 mt-4",children:[(0,r.jsx)("button",{onClick:I,disabled:0===w.size||D,className:"px-4 py-2 bg-green-600 hover:bg-green-500 disabled:opacity-50 rounded text-sm font-medium",children:D?"Saving...":"Accept ".concat(w.size," Edit(s) & Save as New Version")}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-2",children:"A golden set regression will run automatically after saving."})]})]})]})]})}function f(e){let{detection:t}=e,[s,l]=(0,a.useState)([]),[i,n]=(0,a.useState)(null),[d,c]=(0,a.useState)([]),[o,x]=(0,a.useState)(!1),[p,m]=(0,a.useState)(!1),h=(0,a.useCallback)(async()=>{let e=await fetch("/api/datasets?detection_id=".concat(t.detection_id));l(await e.json())},[t.detection_id]);(0,a.useEffect)(()=>{h()},[h]);let u=(0,a.useCallback)(async()=>{if(!i)return void c([]);m(!0);let e=await fetch("/api/datasets?dataset_id=".concat(i));c((await e.json()).items||[]),m(!1)},[i]);(0,a.useEffect)(()=>{u()},[u]);let g=async e=>{confirm("Delete this dataset and all its items? This cannot be undone.")&&(await fetch("/api/datasets",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({dataset_id:e})}),i===e&&(n(null),c([])),h())},b=s.find(e=>e.dataset_id===i),y=e=>d.filter(t=>t.ground_truth_label===e).length;return(0,r.jsxs)("div",{className:"max-w-7xl mx-auto space-y-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"Dataset Manager"}),(0,r.jsxs)("p",{className:"text-sm text-gray-500 mt-1",children:["Upload, inspect, and manage datasets for"," ",(0,r.jsx)("span",{className:"text-gray-300",children:t.display_name})]})]}),(0,r.jsx)("button",{onClick:()=>x(!o),className:"px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm font-medium",children:o?"Cancel":"Upload New Dataset"})]}),o&&(0,r.jsx)(E,{detectionId:t.detection_id,onUploaded:()=>{x(!1),h()}}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[s.map(e=>(0,r.jsxs)("div",{onClick:()=>n(e.dataset_id),className:"border rounded-lg p-4 cursor-pointer transition-all ".concat(i===e.dataset_id?"border-blue-500 bg-blue-900/10 ring-1 ring-blue-500/30":"border-gray-700 bg-gray-800/40 hover:border-gray-600 hover:bg-gray-800/60"),children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,r.jsx)("h3",{className:"font-medium text-sm text-gray-200 truncate flex-1",children:e.name}),(0,r.jsx)("span",{className:"text-xs px-2 py-0.5 rounded ml-2 shrink-0 ".concat(w(e.split_type)),children:e.split_type})]}),(0,r.jsxs)("div",{className:"flex items-center gap-4 text-xs text-gray-400 mt-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)("svg",{className:"w-3.5 h-3.5 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),(0,r.jsxs)("span",{children:[e.size," images"]})]}),(0,r.jsx)("span",{className:"text-gray-600",children:"|"}),(0,r.jsxs)("span",{className:"font-mono text-gray-500",title:"Dataset hash",children:["#",e.dataset_hash.slice(0,8)]})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center mt-3 pt-3 border-t border-gray-700/50",children:[(0,r.jsx)("span",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleDateString()}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),g(e.dataset_id)},className:"text-xs text-gray-600 hover:text-red-400 transition-colors",children:"Delete"})]})]},e.dataset_id)),0===s.length&&(0,r.jsxs)("div",{className:"col-span-full text-center py-12 text-gray-500",children:[(0,r.jsx)("p",{className:"text-sm",children:"No datasets yet for this detection."}),(0,r.jsx)("button",{onClick:()=>x(!0),className:"mt-3 text-sm text-blue-400 hover:text-blue-300",children:"Upload your first dataset"})]})]}),b&&(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg overflow-hidden",children:[(0,r.jsxs)("div",{className:"px-5 py-4 border-b border-gray-700 bg-gray-800/30",children:[(0,r.jsxs)("div",{className:"flex justify-between items-start",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-200",children:b.name}),(0,r.jsxs)("div",{className:"flex items-center gap-3 mt-1.5 text-xs text-gray-400",children:[(0,r.jsx)("span",{className:"px-2 py-0.5 rounded ".concat(w(b.split_type)),children:b.split_type}),(0,r.jsxs)("span",{children:[b.size," images"]}),(0,r.jsxs)("span",{className:"font-mono text-gray-500",children:["hash: ",b.dataset_hash]})]})]}),(0,r.jsxs)("div",{className:"flex gap-3 text-xs",children:[(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-lg font-semibold text-green-400",children:y("DETECTED")}),(0,r.jsx)("div",{className:"text-gray-500",children:"DETECTED"})]}),(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-lg font-semibold text-gray-400",children:y("NOT_DETECTED")}),(0,r.jsx)("div",{className:"text-gray-500",children:"NOT_DET"})]}),(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-lg font-semibold text-purple-400",children:d.length>0?(y("DETECTED")/d.length*100).toFixed(0)+"%":"—"}),(0,r.jsx)("div",{className:"text-gray-500",children:"Prevalence"})]})]})]}),"HELD_OUT_EVAL"===b.split_type&&(0,r.jsx)("div",{className:"mt-3 bg-purple-900/15 border border-purple-800/40 rounded px-3 py-2 text-xs text-purple-400",children:"This is a protected held-out dataset. Items cannot be edited."}),"GOLDEN"===b.split_type&&(0,r.jsx)("div",{className:"mt-3 bg-yellow-900/15 border border-yellow-800/40 rounded px-3 py-2 text-xs text-yellow-400",children:"Golden set — used for regression gating. Changes will affect regression results."})]}),(0,r.jsx)("div",{className:"overflow-x-auto max-h-[500px] overflow-y-auto",children:p?(0,r.jsx)("div",{className:"text-center py-8 text-gray-500 text-sm",children:"Loading items..."}):(0,r.jsxs)("table",{className:"w-full text-sm",children:[(0,r.jsx)("thead",{className:"sticky top-0 bg-gray-800 z-10",children:(0,r.jsxs)("tr",{className:"text-xs text-gray-500 border-b border-gray-700",children:[(0,r.jsx)("th",{className:"text-left py-2.5 px-4 w-12",children:"#"}),(0,r.jsx)("th",{className:"text-left py-2.5 px-4",children:"Image ID"}),(0,r.jsx)("th",{className:"text-left py-2.5 px-4",children:"Preview"}),(0,r.jsx)("th",{className:"text-left py-2.5 px-4",children:"Image URI"}),(0,r.jsx)("th",{className:"text-center py-2.5 px-4",children:"Ground Truth"})]})}),(0,r.jsx)("tbody",{children:d.map((e,t)=>(0,r.jsxs)("tr",{className:"border-b border-gray-800/50 hover:bg-gray-800/30",children:[(0,r.jsx)("td",{className:"py-2 px-4 text-xs text-gray-600",children:t+1}),(0,r.jsx)("td",{className:"py-2 px-4 font-mono text-xs text-gray-300",children:e.image_id}),(0,r.jsx)("td",{className:"py-2 px-4",children:(0,r.jsx)("img",{src:e.image_uri,alt:e.image_id,className:"w-12 h-9 object-cover rounded border border-gray-700",onError:e=>{e.target.style.display="none"}})}),(0,r.jsx)("td",{className:"py-2 px-4 text-xs text-gray-400 max-w-[300px] truncate font-mono",children:e.image_uri}),(0,r.jsx)("td",{className:"text-center py-2 px-4",children:(0,r.jsx)("span",{className:"text-xs px-2 py-0.5 rounded ".concat("DETECTED"===e.ground_truth_label?"bg-green-900/30 text-green-400 border border-green-800/40":"bg-gray-800 text-gray-400 border border-gray-700"),children:"DETECTED"===e.ground_truth_label?"DETECTED":"NOT_DETECTED"})})]},e.item_id))})]})}),(0,r.jsx)("div",{className:"px-5 py-3 border-t border-gray-700 bg-gray-900/30",children:(0,r.jsxs)("details",{className:"text-xs text-gray-500",children:[(0,r.jsx)("summary",{className:"cursor-pointer hover:text-gray-400",children:"Dataset manifest format"}),(0,r.jsx)("pre",{className:"mt-2 bg-gray-900 rounded p-3 font-mono text-gray-400 overflow-x-auto",children:'[\n  {\n    "image_id": "unique_id",\n    "image_uri": "https://... or ./local/path.jpg",\n    "ground_truth_label": "DETECTED" | "NOT_DETECTED"\n  }\n]'})]})})]})]})}function E(e){let{detectionId:t,onUploaded:s}=e,[l,i]=(0,a.useState)(""),[n,d]=(0,a.useState)("ITERATION"),[c,o]=(0,a.useState)(""),[x,p]=(0,a.useState)(""),[m,h]=(0,a.useState)(!1),u=async()=>{p("");try{let e=JSON.parse(c);if(!Array.isArray(e))return void p("Must be a JSON array");if(0===e.length)return void p("Dataset must contain at least one item");for(let t=0;t<e.length;t++){let s=e[t];if(!s.image_id||!s.image_uri||!["DETECTED","NOT_DETECTED"].includes(s.ground_truth_label))return void p("Item ".concat(t,": Each item must have image_id, image_uri, and ground_truth_label (DETECTED|NOT_DETECTED)"))}if(!l.trim())return void p("Dataset name is required");h(!0),await fetch("/api/datasets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:l.trim(),detection_id:t,split_type:n,items:e})}),s()}catch(e){p("Invalid JSON format. Ensure it is a valid JSON array.")}finally{h(!1)}};return(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5 space-y-4",children:[(0,r.jsx)("h3",{className:"text-sm font-medium text-gray-300",children:"Upload New Dataset"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Dataset Name"}),(0,r.jsx)("input",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500",value:l,onChange:e=>i(e.target.value),placeholder:"e.g. Smoke Test Set v2"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Split Type"}),(0,r.jsxs)("select",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500",value:n,onChange:e=>d(e.target.value),children:[(0,r.jsx)("option",{value:"ITERATION",children:"ITERATION — for prompt development, corrections via HIL"}),(0,r.jsx)("option",{value:"GOLDEN",children:"GOLDEN — fixed regression gate set"}),(0,r.jsx)("option",{value:"HELD_OUT_EVAL",children:"HELD_OUT_EVAL — protected final evaluation"}),(0,r.jsx)("option",{value:"CUSTOM",children:"CUSTOM — general purpose"})]})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Dataset Manifest (JSON array)"}),(0,r.jsx)("textarea",{className:"w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-xs font-mono h-40 focus:outline-none focus:border-blue-500",value:c,onChange:e=>o(e.target.value),placeholder:'[\n  { "image_id": "img_001", "image_uri": "https://example.com/img1.jpg", "ground_truth_label": "DETECTED" },\n  { "image_id": "img_002", "image_uri": "https://example.com/img2.jpg", "ground_truth_label": "NOT_DETECTED" }\n]'})]}),x&&(0,r.jsx)("div",{className:"bg-red-900/20 border border-red-800/50 rounded px-3 py-2 text-xs text-red-400",children:x}),(0,r.jsx)("button",{onClick:u,disabled:m,className:"px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 rounded text-sm font-medium",children:m?"Uploading...":"Upload Dataset"})]})}function w(e){switch(e){case"GOLDEN":return"bg-yellow-900/30 text-yellow-400 border border-yellow-800/50";case"ITERATION":return"bg-blue-900/30 text-blue-400 border border-blue-800/50";case"HELD_OUT_EVAL":return"bg-purple-900/30 text-purple-400 border border-purple-800/50";default:return"bg-gray-800 text-gray-400 border border-gray-700"}}function T(e){var t;let{detection:s}=e,{apiKey:l,selectedModel:i}=n(),[d,o]=(0,a.useState)([]),[x,p]=(0,a.useState)([]),[m,h]=(0,a.useState)([]),[u,g]=(0,a.useState)(""),[b,y]=(0,a.useState)(""),[j,_]=(0,a.useState)(!1),[N,v]=(0,a.useState)(""),[f,E]=(0,a.useState)(null),[w,T]=(0,a.useState)(!1),C=(0,a.useCallback)(async()=>{let[e,t,r]=await Promise.all([fetch("/api/prompts?detection_id=".concat(s.detection_id)),fetch("/api/datasets?detection_id=".concat(s.detection_id)),fetch("/api/runs?detection_id=".concat(s.detection_id))]);o(await e.json()),p((await t.json()).filter(e=>"HELD_OUT_EVAL"===e.split_type)),h((await r.json()).filter(e=>"completed"===e.status&&"HELD_OUT_EVAL"===e.split_type))},[s.detection_id]);(0,a.useEffect)(()=>{C()},[C]);let S=async()=>{if(!l)return void alert("Set your Gemini API key first");if(!u||!b)return void alert("Select a prompt version and dataset");let e=x.find(e=>e.dataset_id===b);if(e&&"HELD_OUT_EVAL"!==e.split_type)return void alert("Only HELD_OUT_EVAL datasets can be used here");_(!0),v("Running held-out evaluation..."),E(null);try{let e=await fetch("/api/runs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:l,model_override:i,prompt_version_id:u,dataset_id:b,detection_id:s.detection_id})}),t=await e.json(),r=await fetch("/api/runs?run_id=".concat(t.run_id)),a=await r.json();E(a),C()}catch(e){console.error(e),alert("Evaluation failed")}_(!1),v("")},k=async()=>{if(!f)return;let e=s.metric_thresholds,t=f.metrics_summary,r=[];if(null!=e.min_precision&&t.precision<e.min_precision&&r.push("Precision ".concat((100*t.precision).toFixed(1),"% < ").concat((100*e.min_precision).toFixed(1),"%")),null!=e.min_recall&&t.recall<e.min_recall&&r.push("Recall ".concat((100*t.recall).toFixed(1),"% < ").concat((100*e.min_recall).toFixed(1),"%")),null!=e.min_f1&&t.f1<e.min_f1&&r.push("F1 ".concat((100*t.f1).toFixed(1),"% < ").concat((100*e.min_f1).toFixed(1),"%")),r.length>0)return void alert("Cannot approve: thresholds not met.\n\n".concat(r.join("\n")));T(!0);let a=await fetch("/api/datasets?detection_id=".concat(s.detection_id)),n=(await a.json()).find(e=>"GOLDEN"===e.split_type);if(n&&l){let t=await fetch("/api/runs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:l,model_override:i,prompt_version_id:f.prompt_version_id,dataset_id:n.dataset_id,detection_id:s.detection_id})}),r=await t.json(),a=null;if(s.approved_prompt_version){let e=m.filter(e=>e.prompt_version_id===s.approved_prompt_version);e.length>0&&(a=e[0].metrics_summary)}if(!function(e,t,s){if(null!=t.min_precision&&e.precision<t.min_precision||null!=t.min_recall&&e.recall<t.min_recall||null!=t.min_f1&&e.f1<t.min_f1)return!1;if(s){let r=t.primary_metric||"f1";if(e[r]<s[r])return!1}return!0}(r.metrics,e,a)){alert("Golden regression FAILED. Cannot approve this prompt version."),T(!1);return}await fetch("/api/prompts",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt_version_id:f.prompt_version_id,golden_set_regression_result:{passed:!0,run_id:r.run_id,metrics:r.metrics,previous_metrics:a,evaluated_at:new Date().toISOString()}})})}await fetch("/api/detections",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({detection_id:s.detection_id,display_name:s.display_name,description:s.description,label_policy:s.label_policy,decision_rubric:s.decision_rubric,metric_thresholds:s.metric_thresholds,approved_prompt_version:f.prompt_version_id})}),alert("Prompt version APPROVED!"),T(!1),C()};return(0,r.jsxs)("div",{className:"max-w-7xl mx-auto space-y-6",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"Held-Out Evaluation"}),(0,r.jsx)("div",{className:"bg-yellow-900/20 border border-yellow-800/50 rounded-lg p-4 text-sm text-yellow-400",children:"This tab is for final evaluation only. HELD_OUT_EVAL datasets cannot be used for prompt iteration. Results are stored permanently as run artifacts."}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-xs text-gray-400 font-medium mb-2",children:"Prompt Version"}),(0,r.jsx)("div",{className:"space-y-1.5 max-h-48 overflow-y-auto",children:d.map(e=>(0,r.jsxs)("label",{className:"flex items-center gap-2 p-2 rounded border cursor-pointer text-sm ".concat(u===e.prompt_version_id?"border-blue-600 bg-blue-900/20":"border-gray-700 bg-gray-900/30 hover:border-gray-600"),children:[(0,r.jsx)("input",{type:"radio",name:"prompt",checked:u===e.prompt_version_id,onChange:()=>g(e.prompt_version_id)}),(0,r.jsx)("span",{children:e.version_label}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:e.model}),e.prompt_version_id===s.approved_prompt_version&&(0,r.jsx)("span",{className:"text-xs text-green-400 ml-auto",children:"APPROVED"}),e.golden_set_regression_result&&(0,r.jsxs)("span",{className:"text-xs ml-1 ".concat(e.golden_set_regression_result.passed?"text-green-400":"text-red-400"),children:["Reg: ",e.golden_set_regression_result.passed?"PASS":"FAIL"]})]},e.prompt_version_id))})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-xs text-gray-400 font-medium mb-2",children:"HELD_OUT_EVAL Dataset"}),(0,r.jsxs)("div",{className:"space-y-1.5",children:[x.map(e=>(0,r.jsxs)("label",{className:"flex items-center gap-2 p-2 rounded border cursor-pointer text-sm ".concat(b===e.dataset_id?"border-purple-600 bg-purple-900/20":"border-gray-700 bg-gray-900/30 hover:border-gray-600"),children:[(0,r.jsx)("input",{type:"radio",name:"ho-dataset",checked:b===e.dataset_id,onChange:()=>y(e.dataset_id)}),(0,r.jsx)("span",{children:e.name}),(0,r.jsxs)("span",{className:"text-xs text-gray-500",children:[e.size," images"]}),(0,r.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded bg-purple-900/30 text-purple-400 ml-auto",children:"HELD_OUT"})]},e.dataset_id)),0===x.length&&(0,r.jsx)("p",{className:"text-xs text-gray-500 py-3",children:"No HELD_OUT_EVAL datasets. Upload one in the Detection Setup tab."})]})]})]}),(0,r.jsxs)("div",{className:"mt-4 flex items-center gap-4",children:[(0,r.jsx)("button",{onClick:S,disabled:j||!u||!b,className:"px-4 py-2 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm font-medium",children:j?"Running...":"Run Held-Out Evaluation"}),N&&(0,r.jsx)("span",{className:"text-sm text-gray-400",children:N})]})]}),f&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)(c,{metrics:f.metrics_summary,label:"Held-Out Evaluation Results"}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsx)("h3",{className:"text-sm font-medium mb-3",children:"Threshold Check"}),(0,r.jsxs)("div",{className:"space-y-2 text-sm",children:[null!=s.metric_thresholds.min_precision&&(0,r.jsx)(D,{label:"Precision",value:f.metrics_summary.precision,threshold:s.metric_thresholds.min_precision}),null!=s.metric_thresholds.min_recall&&(0,r.jsx)(D,{label:"Recall",value:f.metrics_summary.recall,threshold:s.metric_thresholds.min_recall}),null!=s.metric_thresholds.min_f1&&(0,r.jsx)(D,{label:"F1",value:f.metrics_summary.f1,threshold:s.metric_thresholds.min_f1})]})]}),(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)("button",{onClick:k,disabled:w,className:"px-4 py-2 bg-green-600 hover:bg-green-500 disabled:opacity-50 rounded text-sm font-medium",children:w?"Approving...":"Approve Prompt Version"}),(0,r.jsx)("button",{onClick:()=>{if(!(null==f?void 0:f.predictions))return;let e=new Blob([["image_id,ground_truth,prediction,confidence,evidence,parse_ok",...f.predictions.map(e=>{var t;return[e.image_id,e.ground_truth_label,e.predicted_decision||"PARSE_FAIL",null!=(t=e.confidence)?t:"",e.evidence||"",e.parse_ok].join(",")})].join("\n")],{type:"text/csv"}),t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download="held-out-eval-".concat(f.run_id.slice(0,8),".csv"),s.click()},className:"px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm",children:"Export CSV"}),(0,r.jsx)("button",{onClick:()=>{if(!f)return;let e=new Blob([JSON.stringify(f,null,2)],{type:"application/json"}),t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download="held-out-eval-".concat(f.run_id.slice(0,8),".json"),s.click()},className:"px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm",children:"Export JSON"})]}),(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsxs)("h3",{className:"text-sm font-medium mb-3",children:["Image-Level Results (",(null==(t=f.predictions)?void 0:t.length)||0,")"]}),(0,r.jsx)("div",{className:"overflow-x-auto max-h-96 overflow-y-auto",children:(0,r.jsxs)("table",{className:"w-full text-xs",children:[(0,r.jsx)("thead",{className:"sticky top-0 bg-gray-800",children:(0,r.jsxs)("tr",{className:"text-gray-500 border-b border-gray-700",children:[(0,r.jsx)("th",{className:"text-left py-2 px-3",children:"Image"}),(0,r.jsx)("th",{className:"text-center py-2 px-3",children:"Ground Truth"}),(0,r.jsx)("th",{className:"text-center py-2 px-3",children:"Prediction"}),(0,r.jsx)("th",{className:"text-center py-2 px-3",children:"Correct"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"Confidence"}),(0,r.jsx)("th",{className:"text-left py-2 px-3",children:"Evidence"}),(0,r.jsx)("th",{className:"text-center py-2 px-3",children:"Parse"})]})}),(0,r.jsx)("tbody",{children:(f.predictions||[]).map(e=>{let t=e.parse_ok&&e.predicted_decision===e.ground_truth_label;return(0,r.jsxs)("tr",{className:"border-b border-gray-800/50 ".concat(t?"":"bg-red-900/5"),children:[(0,r.jsx)("td",{className:"py-1.5 px-3 font-mono",children:e.image_id}),(0,r.jsx)("td",{className:"text-center py-1.5 px-3",children:(0,r.jsx)("span",{className:"px-1.5 py-0.5 rounded ".concat("DETECTED"===e.ground_truth_label?"bg-green-900/30 text-green-400":"bg-gray-800 text-gray-400"),children:"DETECTED"===e.ground_truth_label?"DET":"NOT"})}),(0,r.jsx)("td",{className:"text-center py-1.5 px-3",children:(0,r.jsx)("span",{className:"px-1.5 py-0.5 rounded ".concat("DETECTED"===e.predicted_decision?"bg-green-900/30 text-green-400":"NOT_DETECTED"===e.predicted_decision?"bg-gray-800 text-gray-400":"bg-red-900/30 text-red-400"),children:e.predicted_decision||"FAIL"})}),(0,r.jsx)("td",{className:"text-center py-1.5 px-3",children:t?(0,r.jsx)("span",{className:"text-green-400",children:"✓"}):(0,r.jsx)("span",{className:"text-red-400",children:"✗"})}),(0,r.jsx)("td",{className:"text-right py-1.5 px-3",children:null!=e.confidence?e.confidence.toFixed(2):"—"}),(0,r.jsx)("td",{className:"py-1.5 px-3 text-gray-400 max-w-[200px] truncate",children:e.evidence||"—"}),(0,r.jsx)("td",{className:"text-center py-1.5 px-3",children:e.parse_ok?(0,r.jsx)("span",{className:"text-green-400",children:"OK"}):(0,r.jsx)("span",{className:"text-red-400",children:"FAIL"})})]},e.prediction_id)})})]})})]})]}),m.length>0&&(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-5",children:[(0,r.jsx)("h3",{className:"text-sm font-medium mb-3",children:"Held-Out Run History"}),(0,r.jsx)("div",{className:"space-y-2",children:m.map(e=>{var t,s,a;let l=d.find(t=>t.prompt_version_id===e.prompt_version_id);return(0,r.jsxs)("div",{className:"border border-gray-700 bg-gray-900/30 rounded p-3 text-sm",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsxs)("div",{className:"flex gap-3 items-center",children:[(0,r.jsx)("span",{className:"font-mono text-xs text-gray-400",children:e.run_id.slice(0,8)}),(0,r.jsx)("span",{className:"text-xs",children:(null==l?void 0:l.version_label)||"?"})]}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleString()})]}),(0,r.jsxs)("div",{className:"flex gap-4 mt-1 text-xs text-gray-400",children:[(0,r.jsxs)("span",{children:["F1: ",(0,r.jsxs)("b",{className:"text-yellow-400",children:[(100*((null==(t=e.metrics_summary)?void 0:t.f1)||0)).toFixed(1),"%"]})]}),(0,r.jsxs)("span",{children:["Precision: ",(0,r.jsxs)("b",{className:"text-blue-400",children:[(100*((null==(s=e.metrics_summary)?void 0:s.precision)||0)).toFixed(1),"%"]})]}),(0,r.jsxs)("span",{children:["Recall: ",(0,r.jsxs)("b",{className:"text-green-400",children:[(100*((null==(a=e.metrics_summary)?void 0:a.recall)||0)).toFixed(1),"%"]})]})]})]},e.run_id)})})]})]})}function D(e){let{label:t,value:s,threshold:a}=e,l=s>=a;return(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("span",{className:"text-lg ".concat(l?"text-green-400":"text-red-400"),children:l?"✓":"✗"}),(0,r.jsx)("span",{className:"text-gray-300 w-20",children:t}),(0,r.jsxs)("span",{className:"font-mono",children:[(100*s).toFixed(1),"%"]}),(0,r.jsx)("span",{className:"text-gray-500",children:"≥"}),(0,r.jsxs)("span",{className:"font-mono text-gray-400",children:[(100*a).toFixed(1),"%"]})]})}function C(e){let{detections:t}=e,[s,l]=(0,a.useState)(t),[i,n]=(0,a.useState)(new Map),[d,o]=(0,a.useState)(null),[x,p]=(0,a.useState)(!0);(0,a.useEffect)(()=>{l(t)},[t]);let m=(0,a.useCallback)(async()=>{p(!0);let e=new Map;await Promise.all(s.map(async t=>{let[s,r,a]=await Promise.all([fetch("/api/prompts?detection_id=".concat(t.detection_id)),fetch("/api/datasets?detection_id=".concat(t.detection_id)),fetch("/api/runs?detection_id=".concat(t.detection_id))]);e.set(t.detection_id,{prompts:await s.json(),datasets:await r.json(),runs:(await a.json()).filter(e=>"completed"===e.status)})})),n(e),p(!1)},[s]);return((0,a.useEffect)(()=>{s.length>0?m():p(!1)},[s,m]),x)?(0,r.jsx)("div",{className:"max-w-7xl mx-auto py-12 text-center text-gray-500",children:(0,r.jsx)("p",{className:"text-sm",children:"Loading detection data..."})}):(0,r.jsxs)("div",{className:"max-w-7xl mx-auto space-y-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"Detection Dashboard"}),(0,r.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"Overview of all saved detections with latest run outcomes"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-4 gap-4",children:[(0,r.jsx)(S,{label:"Total Detections",value:s.length.toString(),color:"text-white"}),(0,r.jsx)(S,{label:"With Approved Prompts",value:s.filter(e=>e.approved_prompt_version).length.toString(),color:"text-green-400"}),(0,r.jsx)(S,{label:"Total Runs",value:Array.from(i.values()).reduce((e,t)=>e+t.runs.length,0).toString(),color:"text-blue-400"}),(0,r.jsx)(S,{label:"Total Datasets",value:Array.from(i.values()).reduce((e,t)=>e+t.datasets.length,0).toString(),color:"text-purple-400"})]}),(0,r.jsx)("div",{className:"space-y-3",children:s.map(e=>{let t=i.get(e.detection_id),s=null==t?void 0:t.runs[0],a=(null==s?void 0:s.metrics_summary)||null,l=null==t?void 0:t.prompts.find(t=>t.prompt_version_id===e.approved_prompt_version),n=d===e.detection_id;return(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg overflow-hidden",children:[(0,r.jsx)("div",{className:"px-5 py-4 cursor-pointer hover:bg-gray-800/70 transition-colors",onClick:()=>o(n?null:e.detection_id),children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4 flex-1 min-w-0",children:[(0,r.jsx)("svg",{className:"w-4 h-4 text-gray-500 transition-transform shrink-0 ".concat(n?"rotate-90":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),(0,r.jsxs)("div",{className:"min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("h3",{className:"font-medium text-gray-200 truncate",children:e.display_name}),(0,r.jsx)("code",{className:"text-xs text-gray-500 bg-gray-900 px-1.5 py-0.5 rounded shrink-0",children:e.detection_code})]}),(0,r.jsx)("p",{className:"text-xs text-gray-500 truncate mt-0.5",children:e.description})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-4 shrink-0 ml-4",children:[e.approved_prompt_version?(0,r.jsxs)("span",{className:"text-xs bg-green-900/25 text-green-400 border border-green-800/40 px-2.5 py-1 rounded-full",children:["Approved: ",(null==l?void 0:l.version_label)||"?"]}):(0,r.jsx)("span",{className:"text-xs bg-gray-800 text-gray-500 border border-gray-700 px-2.5 py-1 rounded-full",children:"No approved prompt"}),a&&(0,r.jsxs)("div",{className:"flex gap-3 text-xs",children:[(0,r.jsxs)("span",{children:["P:"," ",(0,r.jsxs)("b",{className:"text-blue-400",children:[(100*a.precision).toFixed(1),"%"]})]}),(0,r.jsxs)("span",{children:["R:"," ",(0,r.jsxs)("b",{className:"text-green-400",children:[(100*a.recall).toFixed(1),"%"]})]}),(0,r.jsxs)("span",{children:["F1:"," ",(0,r.jsxs)("b",{className:"text-yellow-400",children:[(100*a.f1).toFixed(1),"%"]})]})]}),!a&&(0,r.jsx)("span",{className:"text-xs text-gray-600",children:"No runs yet"}),(0,r.jsxs)("div",{className:"flex gap-2 text-xs text-gray-500",children:[(0,r.jsxs)("span",{children:[(null==t?void 0:t.prompts.length)||0," prompts"]}),(0,r.jsx)("span",{className:"text-gray-700",children:"|"}),(0,r.jsxs)("span",{children:[(null==t?void 0:t.datasets.length)||0," datasets"]}),(0,r.jsx)("span",{className:"text-gray-700",children:"|"}),(0,r.jsxs)("span",{children:[(null==t?void 0:t.runs.length)||0," runs"]})]})]})]})}),n&&t&&(0,r.jsxs)("div",{className:"border-t border-gray-700 px-5 py-5 space-y-5 bg-gray-900/20",children:[a&&(0,r.jsx)(c,{metrics:a,label:"Latest Run — ".concat(null==s?void 0:s.split_type," — ").concat(new Date(null==s?void 0:s.created_at).toLocaleString())}),(0,r.jsxs)("div",{className:"bg-gray-800/40 rounded-lg p-4",children:[(0,r.jsx)("h4",{className:"text-xs text-gray-500 font-medium mb-2",children:"Metric Thresholds"}),(0,r.jsxs)("div",{className:"flex gap-6 text-sm",children:[(0,r.jsxs)("span",{className:"text-gray-400",children:["Primary: ",(0,r.jsx)("b",{className:"text-gray-200",children:e.metric_thresholds.primary_metric})]}),null!=e.metric_thresholds.min_precision&&(0,r.jsx)(k,{label:"Precision",threshold:e.metric_thresholds.min_precision,actual:null==a?void 0:a.precision}),null!=e.metric_thresholds.min_recall&&(0,r.jsx)(k,{label:"Recall",threshold:e.metric_thresholds.min_recall,actual:null==a?void 0:a.recall}),null!=e.metric_thresholds.min_f1&&(0,r.jsx)(k,{label:"F1",threshold:e.metric_thresholds.min_f1,actual:null==a?void 0:a.f1})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h4",{className:"text-xs text-gray-500 font-medium mb-2",children:["Run History (",t.runs.length,")"]}),(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full text-xs",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{className:"text-gray-500 border-b border-gray-700",children:[(0,r.jsx)("th",{className:"text-left py-2 px-3",children:"Run"}),(0,r.jsx)("th",{className:"text-left py-2 px-3",children:"Prompt"}),(0,r.jsx)("th",{className:"text-center py-2 px-3",children:"Split"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"Precision"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"Recall"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"F1"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"Accuracy"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"Parse Fail"}),(0,r.jsx)("th",{className:"text-right py-2 px-3",children:"Images"}),(0,r.jsx)("th",{className:"text-left py-2 px-3",children:"Date"})]})}),(0,r.jsx)("tbody",{children:t.runs.slice(0,20).map(e=>{let s=e.metrics_summary,a=t.prompts.find(t=>t.prompt_version_id===e.prompt_version_id);return(0,r.jsxs)("tr",{className:"border-b border-gray-800/50 hover:bg-gray-800/30",children:[(0,r.jsx)("td",{className:"py-2 px-3 font-mono text-gray-400",children:e.run_id.slice(0,8)}),(0,r.jsx)("td",{className:"py-2 px-3",children:(0,r.jsx)("span",{className:"text-gray-300",children:(null==a?void 0:a.version_label)||"?"})}),(0,r.jsx)("td",{className:"text-center py-2 px-3",children:(0,r.jsx)("span",{className:"px-1.5 py-0.5 rounded ".concat(function(e){switch(e){case"GOLDEN":return"bg-yellow-900/30 text-yellow-400";case"ITERATION":return"bg-blue-900/30 text-blue-400";case"HELD_OUT_EVAL":return"bg-purple-900/30 text-purple-400";default:return"bg-gray-800 text-gray-400"}}(e.split_type)),children:e.split_type})}),(0,r.jsxs)("td",{className:"text-right py-2 px-3 text-blue-400",children:[(100*s.precision).toFixed(1),"%"]}),(0,r.jsxs)("td",{className:"text-right py-2 px-3 text-green-400",children:[(100*s.recall).toFixed(1),"%"]}),(0,r.jsxs)("td",{className:"text-right py-2 px-3 text-yellow-400 font-medium",children:[(100*s.f1).toFixed(1),"%"]}),(0,r.jsxs)("td",{className:"text-right py-2 px-3 text-gray-300",children:[(100*s.accuracy).toFixed(1),"%"]}),(0,r.jsx)("td",{className:"text-right py-2 px-3",children:(0,r.jsxs)("span",{className:s.parse_failure_rate>0?"text-yellow-400":"text-gray-500",children:[(100*s.parse_failure_rate).toFixed(1),"%"]})}),(0,r.jsx)("td",{className:"text-right py-2 px-3 text-gray-400",children:s.total}),(0,r.jsx)("td",{className:"py-2 px-3 text-gray-500",children:new Date(e.created_at).toLocaleString()})]},e.run_id)})})]})}),0===t.runs.length&&(0,r.jsx)("p",{className:"text-xs text-gray-600 text-center py-4",children:"No completed runs"})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h4",{className:"text-xs text-gray-500 font-medium mb-2",children:["Prompt Versions (",t.prompts.length,")"]}),(0,r.jsx)("div",{className:"space-y-1.5",children:t.prompts.map(t=>(0,r.jsxs)("div",{className:"flex items-center justify-between px-3 py-2 rounded border text-xs ".concat(t.prompt_version_id===e.approved_prompt_version?"border-green-800/50 bg-green-900/10":"border-gray-700 bg-gray-900/20"),children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("span",{className:"font-medium text-gray-300",children:t.version_label}),(0,r.jsxs)("span",{className:"text-gray-500",children:[t.model," | temp=",t.temperature]}),t.prompt_version_id===e.approved_prompt_version&&(0,r.jsx)("span",{className:"text-green-400 font-medium",children:"APPROVED"}),t.golden_set_regression_result&&(0,r.jsxs)("span",{className:t.golden_set_regression_result.passed?"text-green-400":"text-red-400",children:["Reg: ",t.golden_set_regression_result.passed?"PASS":"FAIL"]})]}),(0,r.jsxs)("span",{className:"text-gray-500",children:[t.created_by," — ",new Date(t.created_at).toLocaleDateString()]})]},t.prompt_version_id))})]})]})]},e.detection_id)})}),0===s.length&&(0,r.jsx)("div",{className:"text-center py-16 text-gray-500",children:(0,r.jsx)("p",{className:"text-sm",children:"No detections found. Create one in the Detection Setup tab."})})]})}function S(e){let{label:t,value:s,color:a}=e;return(0,r.jsxs)("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3",children:[(0,r.jsx)("div",{className:"text-2xl font-bold ".concat(a),children:s}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-0.5",children:t})]})}function k(e){let{label:t,threshold:s,actual:a}=e,l=null!=a?a>=s:null;return(0,r.jsxs)("span",{className:"text-xs text-gray-400",children:[t," ≥ ",(100*s).toFixed(0),"%",null!=l&&(0,r.jsx)("span",{className:"ml-1 ".concat(l?"text-green-400":"text-red-400"),children:l?"✓":"✗"})]})}let O=[{label:"Detection Setup",id:0,step:"1",description:"Define detections, run, and iterate"},{label:"HIL Review",id:1,step:"2",description:"Correct predictions"},{label:"Prompt Feedback",id:2,step:"3",description:"Recompute and improve prompts"},{label:"Prompt Compare",id:3,step:"4",description:"Compare baseline vs improved prompts"},{label:"Held-Out Eval",id:4,step:"5",description:"Final eval and regression gate"},{label:"Datasets",id:5,step:"6",description:"Manage dataset splits and items"},{label:"Saved Detections",id:6,step:"",description:"Detection portfolio overview"}];function P(){var e;let{activeTab:t,setActiveTab:s,selectedDetectionId:l,setSelectedDetectionId:i,apiKey:c,setApiKey:o,selectedModel:p,setSelectedModel:m}=n(),[u,g]=(0,a.useState)([]),[b,y]=(0,a.useState)(!1),[_,N]=(0,a.useState)(d),[E,w]=(0,a.useState)(!1),D=(0,a.useCallback)(async()=>{let e=await fetch("/api/detections"),t=await e.json();g(t),t.length>0&&!l&&i(t[0].detection_id)},[l,i]);(0,a.useEffect)(()=>{D()},[D]),(0,a.useEffect)(()=>{let e=!1;return(async()=>{if(!c)return N(d);w(!0);try{let t=await fetch("/api/gemini/models?api_key=".concat(encodeURIComponent(c))),s=await t.json(),r=Array.isArray(s.models)?s.models:[],a=Array.from(new Set([...d,...r]));e||N(a)}catch(t){e||N(d)}finally{e||w(!1)}})(),()=>{e=!0}},[c]),(0,a.useEffect)(()=>{_.length>0&&!_.includes(p)&&m(_[0])},[_,p,m]);let S=u.find(e=>e.detection_id===l);return(0,r.jsxs)("div",{className:"flex h-screen",children:[(0,r.jsxs)("aside",{className:"w-60 bg-gray-900 border-r border-gray-800 flex flex-col shrink-0",children:[(0,r.jsxs)("div",{className:"px-5 py-4 border-b border-gray-800",children:[(0,r.jsx)("h1",{className:"text-base font-semibold text-white tracking-tight",children:"VLM Eval"}),(0,r.jsx)("p",{className:"text-[10px] text-gray-500 mt-0.5 tracking-wide uppercase",children:"Detection Evaluator"})]}),(0,r.jsxs)("nav",{className:"flex-1 overflow-y-auto py-3",children:[(0,r.jsx)("p",{className:"px-4 mb-2 text-[10px] font-semibold text-gray-600 uppercase tracking-widest",children:"Workflow"}),O.filter(e=>e.step).map((e,a,l)=>{let i=t===e.id;return(0,r.jsxs)("button",{onClick:()=>s(e.id),className:"w-full flex items-start gap-3 px-4 py-2.5 text-left transition-colors group relative ".concat(i?"bg-blue-900/20 text-white":"text-gray-400 hover:bg-gray-800/50 hover:text-gray-200"),children:[i&&(0,r.jsx)("div",{className:"absolute left-0 top-0 bottom-0 w-0.5 bg-blue-500"}),(0,r.jsx)("div",{className:"w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0 mt-0.5 ".concat(i?"bg-blue-600 text-white":"bg-gray-800 text-gray-500 border border-gray-700"),children:e.step}),(0,r.jsxs)("div",{className:"min-w-0",children:[(0,r.jsx)("span",{className:"text-sm font-medium block leading-tight ".concat(i?"text-white":""),children:e.label}),(0,r.jsx)("span",{className:"text-[10px] text-gray-600 block mt-0.5 leading-tight",children:e.description})]}),a<l.length-1&&(0,r.jsx)("div",{className:"absolute left-[30px] -bottom-[2px] w-px h-[6px] bg-gray-800"})]},e.id)}),(0,r.jsx)("div",{className:"mx-4 my-3 border-t border-gray-800"}),O.filter(e=>!e.step).map(e=>{let a=t===e.id;return(0,r.jsxs)("button",{onClick:()=>s(e.id),className:"w-full flex items-center gap-3 px-4 py-2.5 text-left transition-colors relative ".concat(a?"bg-blue-900/20 text-white":"text-gray-400 hover:bg-gray-800/50 hover:text-gray-200"),children:[a&&(0,r.jsx)("div",{className:"absolute left-0 top-0 bottom-0 w-0.5 bg-blue-500"}),(0,r.jsx)("svg",{className:"w-4 h-4 shrink-0 ".concat(a?"text-blue-400":"text-gray-600"),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-sm font-medium ".concat(a?"text-white":""),children:e.label}),(0,r.jsx)("span",{className:"text-[10px] text-gray-600 block mt-0.5",children:e.description})]})]},e.id)})]}),(0,r.jsxs)("div",{className:"border-t border-gray-800 p-4 space-y-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-[10px] text-gray-500 font-medium uppercase tracking-wider block mb-1",children:"Active Detection"}),(0,r.jsxs)("select",{className:"w-full bg-gray-800 border border-gray-700 text-xs rounded px-2.5 py-1.5 text-gray-200 focus:outline-none focus:border-blue-500",value:l||"",onChange:e=>i(e.target.value||null),children:[(0,r.jsx)("option",{value:"",children:"Select Detection"}),u.map(e=>(0,r.jsx)("option",{value:e.detection_id,children:e.display_name},e.detection_id))]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"text-[10px] text-gray-500 font-medium uppercase tracking-wider block mb-1",children:"Gemini Model"}),(0,r.jsx)("select",{className:"w-full bg-gray-800 border border-gray-700 text-xs rounded px-2.5 py-1.5 text-gray-200 focus:outline-none focus:border-blue-500",value:p,onChange:e=>m(e.target.value),children:_.map(e=>(0,r.jsx)("option",{value:e,children:e},e))}),(0,r.jsx)("p",{className:"text-[10px] text-gray-600 mt-1",children:E?"Loading available models...":"Models discovered from your API key."})]}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("button",{onClick:()=>y(!b),className:"w-full text-xs px-2.5 py-1.5 rounded border text-left ".concat(c?"border-green-800/50 text-green-400 bg-green-900/15":"border-yellow-800/50 text-yellow-400 bg-yellow-900/15"),children:c?"Gemini API Key Set":"Set Gemini API Key"}),b&&(0,r.jsxs)("div",{className:"absolute left-0 bottom-full mb-2 bg-gray-800 border border-gray-700 rounded-lg p-3 z-50 shadow-xl w-72",children:[(0,r.jsx)("label",{className:"text-xs text-gray-400 block mb-1",children:"Gemini API Key"}),(0,r.jsx)("input",{type:"password",className:"w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500",value:c,onChange:e=>o(e.target.value),placeholder:"AIza..."}),(0,r.jsx)("p",{className:"text-[10px] text-gray-500 mt-1",children:"Stored in memory only."}),(0,r.jsx)("button",{onClick:()=>y(!1),className:"mt-2 text-xs text-blue-400 hover:text-blue-300",children:"Close"})]})]})]})]}),(0,r.jsxs)("main",{className:"flex-1 overflow-auto bg-gray-950 flex flex-col",children:[(0,r.jsxs)("div",{className:"border-b border-gray-800 bg-gray-900/40 px-6 py-2.5 flex items-center justify-between shrink-0",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("h2",{className:"text-sm font-medium text-gray-200",children:null==(e=O.find(e=>e.id===t))?void 0:e.label}),S&&6!==t&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("span",{className:"text-gray-700",children:"|"}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:S.display_name}),(0,r.jsx)("code",{className:"text-[10px] text-gray-600 bg-gray-800 px-1.5 py-0.5 rounded",children:S.detection_code})]})]}),(null==S?void 0:S.approved_prompt_version)&&6!==t&&(0,r.jsx)("span",{className:"text-[10px] bg-green-900/20 text-green-500 border border-green-800/40 px-2 py-0.5 rounded",children:"Approved prompt active"})]}),(0,r.jsx)("div",{className:"flex-1 overflow-auto p-6",children:l||0===t||6===t?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:0===t?"block":"hidden",children:(0,r.jsx)(x,{detections:u,selectedDetection:S||null,onRefresh:D})}),S&&(0,r.jsx)("div",{className:1===t?"block":"hidden",children:(0,r.jsx)(j,{detection:S})}),S&&(0,r.jsx)("div",{className:2===t?"block":"hidden",children:(0,r.jsx)(v,{detection:S})}),S&&(0,r.jsx)("div",{className:3===t?"block":"hidden",children:(0,r.jsx)(h,{detection:S})}),S&&(0,r.jsx)("div",{className:4===t?"block":"hidden",children:(0,r.jsx)(T,{detection:S})}),S&&(0,r.jsx)("div",{className:5===t?"block":"hidden",children:(0,r.jsx)(f,{detection:S})}),(0,r.jsx)("div",{className:6===t?"block":"hidden",children:(0,r.jsx)(C,{detections:u})})]}):(0,r.jsxs)("div",{className:"text-center py-20 text-gray-500",children:[(0,r.jsx)("p",{className:"text-lg",children:"Select a detection to get started"}),(0,r.jsx)("p",{className:"text-sm mt-2",children:"Use the sidebar dropdown or create a new detection in Step 1"})]})})]})]})}},7336:(e,t,s)=>{Promise.resolve().then(s.bind(s,4839))}},e=>{e.O(0,[441,255,358],()=>e(e.s=7336)),_N_E=e.O()}]);